<script>
    // 設定を定数として一度だけ宣言
    const CONFIG = {
        // index.htmlと同じGAS URLを設定してください
        GAS_BASE_URL: 'https://cat-seven-blond.vercel.app/api/gas-proxy' 
    };
    const ASSETS_API = `${CONFIG.GAS_BASE_URL}?api=assets`;

    let allAssets = [];

    // --- ユーティリティ: ファイルをData URL (Base64) として読み込む ---
    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // --- 初期化 ---
    window.onload = async () => {
        await loadAssets();
        
        // 検索フィルター
        document.getElementById('search-input').addEventListener('input', (e) => {
            renderList(e.target.value);
        });

        // プレビュー機能: ファイル入力の監視
        document.getElementById('edit-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const previewImg = document.getElementById('preview-img');
            const urlInput = document.getElementById('edit-url');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                };
                reader.readAsDataURL(file);
                // ファイルが選択されたらURL欄はクリア（優先順位を明確にするため）
                urlInput.value = '';
            }
        });

        // プレビュー機能: URL入力の監視
        document.getElementById('edit-url').addEventListener('input', (e) => {
            const fileInput = document.getElementById('edit-file');
            const previewImg = document.getElementById('preview-img');
            
            // ファイルが選択されていない場合のみURLプレビューを有効にする
            if (!fileInput.files.length) {
                previewImg.src = e.target.value;
            }
        });
    };

    // --- データ取得 ---
    async function loadAssets() {
        showLoading(true);
        try {
            // characterタイプのみ取得
            const res = await fetch(`${ASSETS_API}&filters=asset_type[equals]character`);
            if (!res.ok) throw new Error('Network error');
            
            const data = await res.json();
            allAssets = Array.isArray(data) ? data : (data.contents || []);
            
            renderList();
        } catch (e) {
            alert('読み込みに失敗しました: ' + e.message);
        } finally {
            showLoading(false);
        }
    }

    // --- リスト描画 ---
    function renderList(keyword = '') {
        const container = document.getElementById('character-container');
        container.innerHTML = '';

        // キーワードフィルタ
        const filtered = allAssets.filter(a => {
            if (!a.tag) return false;
            return a.tag.toLowerCase().includes(keyword.toLowerCase());
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#64748b;">該当するキャラクターが見つかりません</div>';
            return;
        }

        // キャラクター名(tag)でグループ化
        const groups = {};
        filtered.forEach(a => {
            if (!groups[a.tag]) groups[a.tag] = [];
            groups[a.tag].push(a);
        });

        // グループごとに描画
        Object.keys(groups).sort().forEach(tagName => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'char-group';

            const header = document.createElement('div');
            header.className = 'char-name-header';
            header.textContent = tagName;
            groupDiv.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'asset-grid';

            // 表情タグ順にソート（defaultを先頭に）
            const sortedAssets = groups[tagName].sort((a, b) => {
                const fa = a.character_face_tag || '';
                const fb = b.character_face_tag || '';
                if (fa === 'default' || fa === '') return -1;
                if (fb === 'default' || fb === '') return 1;
                return fa.localeCompare(fb);
            });

            sortedAssets.forEach(asset => {
                const card = document.createElement('div');
                card.className = 'asset-card';
                
                const faceName = asset.character_face_tag || 'default';
                
                card.innerHTML = `
                    <div class="img-wrapper" data-asset-id="${asset.id}">
                        <img class="asset-img" src="${asset.image}" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiMzMzMiLz48dGV4dCB4PSI1MCIgeT0iNTAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tk8gSU1BR0U8L3RleHQ+PC9zdmc+'">
                    </div>
                    <div class="card-info">
                        <span class="face-tag">${faceName}</span>
                        <button class="edit-btn" data-asset-id="${asset.id}">編集 / 差替</button>
                    </div>
                `;
                grid.appendChild(card);
                
                // イベントリスナーを後から追加する方がより堅牢
                card.querySelector('.edit-btn').addEventListener('click', () => openModal(asset));
                card.querySelector('.img-wrapper').addEventListener('click', () => openModal(asset));
            });

            groupDiv.appendChild(grid);
            container.appendChild(groupDiv);
        });
    }

    // --- モーダル操作 ---
    window.openModal = (asset) => {
        const modal = document.getElementById('edit-modal');
        document.getElementById('edit-id').value = asset.id;
        document.getElementById('edit-tag').value = asset.tag;
        document.getElementById('edit-face').value = asset.character_face_tag || 'default';
        
        // モーダルを開くときに、ファイル入力とURL入力をクリア/設定
        document.getElementById('edit-file').value = ''; 
        document.getElementById('edit-url').value = asset.image;
        document.getElementById('preview-img').src = asset.image;
        
        modal.style.display = 'flex';
    };

    window.closeModal = () => {
        document.getElementById('edit-modal').style.display = 'none';
    };

    // ===========================================
    // ▼ 更新処理 (最終修正箇所)
    // ===========================================
    document.getElementById('edit-form').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const fileInput = document.getElementById('edit-file');
        const urlInput = document.getElementById('edit-url');
        
        let imageUrlOrBase64;
        
        showLoading(true);
        
        try {
            if (fileInput.files.length > 0) {
                // 1. ファイルが選択されている場合 (Base64を優先)
                imageUrlOrBase64 = await readFileAsDataURL(fileInput.files[0]);
            } else if (urlInput.value.trim()) {
                // 2. ファイルがなく、URLが入力されている場合
                imageUrlOrBase64 = urlInput.value.trim();
            } else {
                // 3. どちらも空の場合
                alert('新しい画像ファイルを選択するか、URLを入力してください。');
                showLoading(false);
                return;
            }

            // APIリクエストURLはシンプルにアセットAPIのベースパスを使用
            const updateUrl = `${ASSETS_API}&id=${id}`;

            // 送信するデータオブジェクト
            const dataToSend = {
                // 実際の操作がPUTであることをGASプロキシに伝える
                _method: "PUT", 
                // 更新したいフィールド (Base64またはURL)
                image: imageUrlOrBase64, 
            };

            // アセット更新APIリクエスト
            const res = await fetch(updateUrl, {
                method: 'POST', // すべての書き込み操作はPOSTで送信
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            });

            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`Server error: ${res.status}. ${errText}`);
            }

            alert('画像を更新しました');
            closeModal();
            loadAssets(); // リスト再読み込み

        } catch (e) {
            console.error('更新エラー:', e);
            alert('更新エラー: ' + e.message);
        } finally {
            showLoading(false);
        }
    };

    function showLoading(show) {
        const el = document.getElementById('loading');
        el.style.opacity = show ? 1 : 0;
        el.style.pointerEvents = show ? 'auto' : 'none';
    }

</script>
