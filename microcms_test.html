<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>å‹‡è€…ãƒãƒ¼ãƒ¬ãƒ  - ãƒãƒ™ãƒ«ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        #header { height: 48px; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: space-between; padding: 0 12px; }
        #novel-container { position: relative; height: calc(100% - 48px); }
        #background, #special-image { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 0; }
        #special-image { object-fit: contain; background: none; } /* ä¸€æšçµµã®å ´åˆ */
        #character { position: absolute; bottom: -10%; left: 50%; transform: translateX(-50%); max-height: 70%; max-width: 100%; object-fit: contain; z-index: 1; transition: filter 0.3s ease; }
        #character.dimmed { filter: brightness(40%) saturate(50%); }
        #dialogue-box { position: absolute; bottom: 0; width: 100%; height: 25%; background: rgba(0, 0, 0, 0.6); padding: 16px; z-index: 2; transition: height 0.3s ease; overflow: hidden; box-sizing: border-box; }
        #dialogue-box.expanded { height: 80%; overflow-y: auto; }
        #speaker { font-weight: bold; }
        #text { margin-top: 8px; line-height: 1.6; }
        #edit-form { display: none; }
        #dialogue-box.expanded #edit-form { display: block; margin-top: 12px; }
        label { display: block; margin-top: 8px; }
        select, textarea, input { width: 100%; margin-top: 4px; font-size: 14px; padding: 4px; box-sizing: border-box; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #555; border-radius: 4px;}
        button { margin-top: 12px; padding: 6px 12px; background: #333; color: #fff; border: none; cursor: pointer; border-radius: 4px; }
        .episode-nav-btn { background: #555; margin: 0 5px; }
        #close-log { display: none; position: absolute; top: 8px; right: 12px; font-size: 20px; cursor: pointer; z-index: 3; }
        #dialogue-box.expanded #close-log { display: block; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none; position: fixed; z-index: 10;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); justify-content: center; align-items: center;
        }
        .modal-content {
            background: #222; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;
            position: relative; /* Closeãƒœã‚¿ãƒ³ã®ä½ç½®æ±ºã‚ã®ãŸã‚ */
        }
        .modal-close {
            position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer;
        }

        /* è¨­å®šãƒœã‚¿ãƒ³æ¨ªã®ãƒ“ãƒƒã‚¯ãƒªãƒãƒ¼ã‚¯ */
        #settings-button-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        #missing-assets-indicator {
            color: yellow;
            font-size: 20px;
            margin-left: 5px;
            cursor: pointer;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }

        #loading-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); color: white;
            justify-content: center; align-items: center; font-size: 24px; z-index: 100;
        }

        /* ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        #asset-upload-modal-content h3 {
            margin-top: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        #asset-upload-form label {
            margin-top: 10px;
        }
        #asset-upload-form select,
        #asset-upload-form input[type="file"] {
            margin-top: 5px;
            padding: 8px;
            background: #333;
            border: 1px solid #666;
        }
    </style>
</head>
<body>
<div id="header">
    <div id="episode-navigation">
        <button class="episode-nav-btn" onclick="changeEpisode(-1)">â—€</button>
        <span id="current-episode-display">ç¬¬1è©±</span>
        <button class="episode-nav-btn" onclick="changeEpisode(1)"> â–¶</button>
    </div>
    <div id="scene-title">#1</div>  <div id="controls">
        <div id="settings-button-wrapper">
            <button onclick="openModal()">âš™ï¸ è¨­å®š</button>
            <span id="missing-assets-indicator" onclick="openAssetUploadModal()">â—</span>
        </div>
    </div>
</div>

<div id="novel-container">
    <div id="background"></div>
    <img id="special-image" src="" alt="" style="display:none;" /> <img id="character" src="" alt="" />
    <div id="dialogue-box">
        <div id="speaker"></div>
        <div id="text"></div>
   <div id="edit-form">
        <label>è©±è€…ï¼š<input type="text" id="edit-speaker"></label>
        <label>ã‚»ãƒªãƒ•ï¼š<textarea id="edit-text" rows="3"></textarea></label>
        <label>è¡¨æƒ…ï¼š<input type="text" id="edit-face"></label>
        <label>èƒŒæ™¯ï¼š<input type="text" id="edit-bg"></label>
        <label>ç‰¹æ®Šï¼š<input type="text" id="edit-special" placeholder="ç‰¹æ®ŠåŠ¹æœã‚„ã‚¢ã‚»ãƒƒãƒˆã‚¿ã‚°" /></label>
        <button onclick="applyEdits()">âœ… é©ç”¨</button>
        <button onclick="deleteScene()" style="background: #a00; margin-left: 8px;">ğŸ—‘ï¸ ã“ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤</button>
        <button onclick="addScene()" style="background: #0a0; margin-left: 8px;">â• ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ </button>
    </div>
        <div id="close-log" onclick="collapseLog()">âœ•</div>
    </div>
</div>
<div id="novel-container">
    <div id="dialogue-box">
        <div id="speaker"></div> <div id="text"></div>     </div>
</div>
<div id="modal" class="modal">
    <div id="modal-content" class="modal-content">
        <div id="modal-close" class="modal-close" onclick="closeModal()">âœ•</div>
        <h2>è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <button onclick="saveProgress()">ğŸ’¾ é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜</button><br><br>
        <button onclick="loadProgress()">ğŸ“‚ ç¶šãã‹ã‚‰å†é–‹</button><br><br>
        <button onclick="toggleVoice()">ğŸ”Š èª­ã¿ä¸Šã’: <span id="voice-status">ã‚ªãƒ•</span></button><br><br>
        <button onclick="downloadAllScenes()">â¬‡ï¸ å…¨ã‚·ãƒ¼ãƒ³ã‚’JSONã§ä¿å­˜</button><br><br>
        <button onclick="uploadScenes()">â¬†ï¸ å…¨ã‚·ãƒ¼ãƒ³ã‚’JSONã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button><br><br>
        <a href="assets_editor.html" target="_blank" style="display: block; margin-top: 15px; color: #87CEEB; text-decoration: none;">ğŸ–¼ï¸ ã‚¢ã‚»ãƒƒãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
    </div>
</div>

<div id="asset-upload-modal" class="modal">
    <div id="asset-upload-modal-content" class="modal-content">
        <div id="asset-upload-modal-close" class="modal-close" onclick="closeAssetUploadModal()">âœ•</div>
        <h2>ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
        <p>ç¾åœ¨ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ãŒã€microCMSã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚»ãƒƒãƒˆã§ã™ã€‚</p>
        <form id="asset-upload-form" onsubmit="event.preventDefault();">
            <label for="missing-asset-select">ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆã‚’é¸æŠ:</label>
            <select id="missing-asset-select">
                <option value="">--ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆãªã—--</option>
            </select>

            <label for="upload-single-asset-file" style="margin-top: 15px;">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
            <input type="file" id="upload-single-asset-file" accept=".jpg,.jpeg,.png,.gif">
            
            <button type="button" onclick="handleSingleAssetUpload()" style="margin-top: 20px;">â¬†ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿å­˜</button>
            <p style="font-size: 12px; color: #aaa; margin-top: 10px;">
                â€»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã¯ã€Œã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å_è¡¨æƒ….pngã€ã®å‘½åè¦å‰‡ã‚’æ¨å¥¨ã—ã¾ã™ã€‚<br>
                ã€€ä¾‹: `hero_smile.png` -> `tag: hero`, `character_face_tag: smile`
            </p>
        </form>
    </div>
</div>

<input type="file" id="file-input" style="display: none;" accept=".json" onchange="handleFileUpload(event)">
<div id="loading-overlay">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<script>
// â˜…â˜…â˜… å¤‰æ›´ç‚¹: ã“ã“ã‹ã‚‰ â˜…â˜…â˜…
// GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®š
const GAS_BASE_URL = 'https://script.google.com/macros/s/AKfycbws8iWylo3bDjp7nlALpjNlGxS5En8AZtxMnF43pZZ5htZxqydHO4iVKjVOfudyfnnIGA/exec';

// GASã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´
const ASSETS_PROXY_PATH = `${GAS_BASE_URL}?api=assets`;
const SCENES_PROXY_PATH = `${GAS_BASE_URL}?api=scenes`;
// SPECIFIC_SCENE_PROXY_PATH ã¯ç›´æ¥ä½¿ç”¨ã›ãšã€URLã‚’å‹•çš„ã«æ§‹ç¯‰ã—ã¾ã™ã€‚
// UPLOAD_PROXY_PATH ã‚‚GASã®assets APIã‚’æŒ‡ã—ã¾ã™ãŒã€ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã§ãã¾ã›ã‚“ã€‚
const UPLOAD_PROXY_PATH = `${GAS_BASE_URL}?api=assets`; // GASã¯multipart/form-dataã®ç›´æ¥å‡¦ç†ã«ã¯éå¯¾å¿œ

let currentEpisodeScenes = [];
let loadedAssets = { backgrounds: {}, characters: {}, effects: {}, specialImages: {} };
let currentSceneIndex = 0;
let useVoice = false;
let currentEpisodeNumber = 1;
let missingAssets = []; // ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’çµ±ä¸€
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ã®å¤‰æ•°
        let speakersDataCache = [];
        let facesDataCache = [];
        let backgroundsDataCache = [];

    

// UIè¦ç´ ã®å–å¾—
const speakerSelect = document.getElementById("edit-speaker");
const faceSelect = document.getElementById("edit-face");
const bgSelect = document.getElementById("edit-bg");
const characterElement = document.getElementById("character");
const specialImageElement = document.getElementById("special-image");
const backgroundElement = document.getElementById("background");
const loadingOverlay = document.getElementById('loading-overlay');
const missingAssetsIndicator = document.getElementById('missing-assets-indicator');
const missingAssetSelect = document.getElementById('missing-asset-select'); // æ–°ã—ã„ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³


// --- åˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
document.addEventListener('DOMContentLoaded', async () => {
    const savedEpisode = localStorage.getItem('yh_current_episode');
    if (savedEpisode && !isNaN(parseInt(savedEpisode))) {
        currentEpisodeNumber = parseInt(savedEpisode);
    }
    document.getElementById('current-episode-display').textContent = `ç¬¬${currentEpisodeNumber}è©±`;
    await loadEpisodeData(currentEpisodeNumber);
    showScene(currentSceneIndex);
});

async function loadEpisodeData(episodeNumber) {
    showLoadingOverlay(true);
    console.log(`ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ ${episodeNumber} ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...`);
    currentEpisodeNumber = episodeNumber;
    localStorage.setItem('yh_current_episode', currentEpisodeNumber);

    try {
        // APIãƒ«ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥é…åˆ—ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€fetchAllDataWithPaginationã®å‘¼ã³å‡ºã—æ–¹ã‚’å¤‰æ›´
        // ç¬¬äºŒå¼•æ•°ã®`episodeNumber`ã¯APIãƒ«ãƒ¼ãƒˆã«ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹
        // ç¬¬ä¸‰å¼•æ•°ã®`filters`ã¯`api/scenes.js`ãŒå†…éƒ¨ã§å‡¦ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦
        currentEpisodeScenes = await fetchAllDataWithPagination(SCENES_PROXY_PATH, episodeNumber); 
        currentEpisodeScenes.sort((a, b) => (a.sceneNumber || 0) - (b.sceneNumber || 0));

        console.log(`ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ ${episodeNumber} ã®ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿:`, currentEpisodeScenes);

        if (currentEpisodeScenes.length === 0) {
            alert(`ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ ${episodeNumber} ã«ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
            showLoadingOverlay(false);
            populateSelectOptions();
            checkMissingAssets();
            return;
        }

        // å¿…è¦ãªã‚¢ã‚»ãƒƒãƒˆã‚¿ã‚°ã‚’åé›†
        const requiredBackgroundTags = new Set();
        const requiredCharacterTags = new Set();
        const requiredFaceTags = new Set();
        const requiredSpecialImageTags = new Set();
        const requiredEffectTags = new Set(); // åŠ¹æœéŸ³ç”¨

        currentEpisodeScenes.forEach(scene => {
            // â˜… ä¿®æ­£: scene.background ãŒç›´æ¥URLã®å ´åˆã¨æ–‡å­—åˆ—ï¼ˆã‚¿ã‚°ï¼‰ã®å ´åˆã‚’ä¸¡æ–¹è€ƒæ…®ã™ã‚‹
            // APIãƒ«ãƒ¼ãƒˆãŒå¸¸ã«URLã‚’è¿”ã—ã¦ã„ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®tagåé›†ãƒ­ã‚¸ãƒƒã‚¯ã¯ç°¡ç´ åŒ–ã§ãã¾ã™
            if (typeof scene.background === 'string' && !scene.background.startsWith('http') && scene.background !== "ãªã—") {
                requiredBackgroundTags.add(scene.background);
            }
            if (scene.speaker && scene.speaker !== "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³") {
                requiredCharacterTags.add(scene.speaker);
                if (scene.face) requiredFaceTags.add(scene.face);
            }
            if (scene.character && scene.character !== "ãªã—") {
                requiredCharacterTags.add(scene.character);
                if (scene.face) requiredFaceTags.add(scene.face);
            }
            if (scene.special && scene.special !== "ãªã—") {
                // specialãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æœè£…/å§¿åˆ‡ã‚Šæ›¿ãˆã®å ´åˆã‚‚è€ƒæ…®ã—ã€å¯¾å¿œã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¿ã‚°ã¨è¡¨æƒ…ã‚¿ã‚°ã‚’åé›†
                const parts = scene.special.split('_');
                if (parts.length > 1) {
                    const charTag = parts[0];
                    const faceTag = parts.slice(1).join('_');
                    requiredCharacterTags.add(charTag);
                    requiredFaceTags.add(faceTag);
                }
                // specialãŒä¸€æšçµµã®ã‚¿ã‚°ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹å ´åˆã‚‚åé›†
                requiredSpecialImageTags.add(scene.special);
            }
            // åŠ¹æœéŸ³ã®åé›†
            if (scene.effect && scene.effect !== "ãªã—") {
                requiredEffectTags.add(scene.effect);
            }
        });

        // å¿…è¦ãªã‚¢ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«æ ¼ç´
        loadedAssets = { backgrounds: {}, characters: {}, effects: {}, specialImages: {} };

        // èƒŒæ™¯ (APIãƒ«ãƒ¼ãƒˆãŒURLã‚’è¿”ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯loadedAssetsã«ç›´æ¥URLã‚’æ ¼ç´ã™ã‚‹)
        // ã‚‚ã—APIãƒ«ãƒ¼ãƒˆãŒæ–‡å­—åˆ—ã‚¿ã‚°ã‚’è¿”ã—ã¦ã„ã‚‹ãªã‚‰ã€ã“ã®éƒ¨åˆ†ã§ASSETS_PROXY_PATHã‚’å©ã
        // ç¾çŠ¶ã€APIãƒ«ãƒ¼ãƒˆãŒURLã«å¤‰æ›ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦ã€ã‚ã‚‹ã„ã¯ç°¡ç´ åŒ–
        currentEpisodeScenes.forEach(scene => {
            if (scene.background && typeof scene.background === 'string' && scene.background.startsWith('http')) {
                // APIãƒ«ãƒ¼ãƒˆãŒã™ã§ã«URLã‚’è¿”ã—ã¦ã„ã‚‹å ´åˆ
                // backgroundã®tagãŒä¸æ˜ãªã®ã§ã€å˜ç´”ã«URLã‚’ã‚»ãƒƒãƒˆ
                // ã“ã‚Œã¯å³å¯†ã«ã¯loadedAssets.backgrounds[tag] = url; ã®æ§‹é€ ã«åˆã‚ãªã„ãŒã€
                // showSceneã§ç›´æ¥åˆ©ç”¨ã™ã‚‹ãŸã‚è¨±å®¹
                // ã‚ˆã‚Šå³å¯†ãªã‚‰ã€APIãƒ«ãƒ¼ãƒˆã‹ã‚‰tagã‚‚ä¸€ç·’ã«è¿”ã—ã¦ã‚‚ã‚‰ã†æ–¹ãŒè‰¯ã„
                // ã¨ã‚Šã‚ãˆãšã€backgroundElement.style.backgroundImage = `url('${s.background}')`; ã®ã‚ˆã†ã«ç›´æ¥ä½¿ã†
            }
            // ã‚‚ã—APIãƒ«ãƒ¼ãƒˆãŒã‚¿ã‚°æ–‡å­—åˆ—ã‚’è¿”ã—ã¦ã„ã‚‹ãªã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ASSETS_PROXY_PATHã‚’å©ã
            // if (requiredBackgroundTags.size > 0) {
            //     const bgFilter = `asset_type[contains]background[and](${Array.from(requiredBackgroundTags).map(tag => `tag[equals]${tag}`).join('[or]')})`
            //     const bgAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=${bgFilter}`);
            //     bgAssets.forEach(asset => { if (asset.image) loadedAssets.backgrounds[asset.tag] = asset.image.url; });
            // }
        });
        // æ—¢å­˜ã®èƒŒæ™¯ã‚¢ã‚»ãƒƒãƒˆã® loadedAssets.backgrounds ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ã€APIã‹ã‚‰å–å¾—ã—ãŸURLã‚’ç›´æ¥ä½¿ã†å ´åˆã€ç”¨é€”ãŒé™å®šçš„ã«ãªã‚‹ã€‚
        // `showScene`é–¢æ•°ã§`s.background`ã‚’ç›´æ¥èƒŒæ™¯URLã¨ã—ã¦ä½¿ã†ã“ã¨ã«å¤‰æ›´ã™ã‚‹ã®ã§ã€
        // ã“ã“ã§ã®`loadedAssets.backgrounds`ã¸ã®æ˜ç¤ºçš„ãªæ ¼ç´ã¯ã€ä¸»ã«`populateSelectOptions`ã®ãŸã‚ã®ã‚‚ã®ã¨ãªã‚‹ã€‚
        // ãã®ãŸã‚ã€ã“ã“ã§ã¯`bgSelect`ã®ãŸã‚ã®æ—¢å­˜ã®èƒŒæ™¯ã‚¿ã‚°ã¨ã€ãã®URLã‚’åé›†ã™ã‚‹ã€‚
        if (requiredBackgroundTags.size > 0) {
            // filtersã§asset_typeãŒbackgroundã‹ã¤tagãŒè©²å½“ã™ã‚‹ã‚‚ã®ã‚’å–å¾—
            const bgAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=asset_type[contains]background[and](${Array.from(requiredBackgroundTags).map(tag => `tag[equals]${tag}`).join('[or]')})`);
            bgAssets.forEach(asset => { 
                if (asset.image) {
                    loadedAssets.backgrounds[asset.tag] = asset.image.url;
                }
            });
        }


        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
            if (requiredCharacterTags.size > 0) {
                // ã“ã“ã‚’ä¿®æ­£: asset_type[contains] ã‚’ asset_type[equals] ã«å¤‰æ›´
                let charFilter = `asset_type[equals]character[and](${Array.from(requiredCharacterTags).map(tag => `tag[equals]${tag}`).join('[or]')})`;
                // è¡¨æƒ…ã‚¿ã‚°ã‚‚æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚ˆã‚Šå³å¯†ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹
                if (requiredFaceTags.size > 0) {
                    charFilter += `[and](${Array.from(requiredFaceTags).map(tag => `character_face_tag[equals]${tag}`).join('[or]')})`;
                }
                const charAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=${charFilter}`);
                charAssets.forEach(asset => {
                // â˜… ä¿®æ­£: character_face_image.url ã‹ã‚‰ image.url ã«å¤‰æ›´
                if (asset.image && asset.image.url) { // imageãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ã€URLã‚’æŒã¤ã‹ç¢ºèª
                    if (!loadedAssets.characters[asset.tag]) {
                        loadedAssets.characters[asset.tag] = {};
                    }
                    loadedAssets.characters[asset.tag][asset.character_face_tag || 'default'] = asset.image.url;
                }
            });
        }

        // ç‰¹æ®Šç”»åƒ (ä¸€æšçµµãªã©)
        if (requiredSpecialImageTags.size > 0) {
             const specialImageFilter = `asset_type[contains]special_image[and](${Array.from(requiredSpecialImageTags).map(tag => `tag[equals]${tag}`).join('[or]')})`;
             const specialImageAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=${specialImageFilter}`);
             specialImageAssets.forEach(asset => { if (asset.image) loadedAssets.specialImages[asset.tag] = asset.image.url; });
        }

        // åŠ¹æœéŸ³
        if (requiredEffectTags.size > 0) {
            const effectFilter = `asset_type[contains]effect[and](${Array.from(requiredEffectTags).map(tag => `tag[equals]${tag}`).join('[or]')})`;
            const effectAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=${effectFilter}`);
            effectAssets.forEach(asset => { if (asset.image) loadedAssets.effects[asset.tag] = asset.image.url; }); // effectã‚‚imageãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å–å¾—
        }


        console.log(`ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ ${episodeNumber} ã§å¿…è¦ãªã‚¢ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:`, loadedAssets);

        currentSceneIndex = 0;
        showScene(currentSceneIndex);
        populateSelectOptions();
        checkMissingAssets();

    } catch (error) {
        console.error(`ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ ${episodeNumber} ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
        alert(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã€ã‚µãƒ¼ãƒ“ã‚¹IDã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
        currentEpisodeScenes = [];
        loadedAssets = { backgrounds: {}, characters: {}, effects: {}, specialImages: {} };
        checkMissingAssets();
    } finally {
        showLoadingOverlay(false);
    }
}

// fetchAllDataWithPaginationé–¢æ•°ã‚’APIãƒ«ãƒ¼ãƒˆãŒç›´æ¥é…åˆ—ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£
async function fetchAllDataWithPagination(proxyPath, episode = null, filters = '') { // episodeã¯scenesãƒ‘ã‚¹ã®ã¿ã§ä½¿ç”¨ã€‚assetsãƒ‘ã‚¹ã§ã¯ä¸è¦ãªã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆnull
    let url = proxyPath;
    const params = new URLSearchParams();

    // scenes_proxy_pathã®å ´åˆã®ã¿episodeã‚’è¿½åŠ 
    if (proxyPath === SCENES_PROXY_PATH && episode !== null) {
        params.append('episode', episode);
    }
    
    // filtersãŒã‚ã‚Œã°è¿½åŠ 
    if (filters) {
        // filtersã¯ã™ã§ã«URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã—ã€ãã®ã¾ã¾è¿½åŠ 
        // URLSearchParamsã¯è‡ªå‹•ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã®ã§ã€ã“ã“ã§ã¯ãã®ã¾ã¾è¿½åŠ 
        const filterParams = new URLSearchParams(filters);
        filterParams.forEach((value, key) => params.append(key, value));
    }
    
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°URLã«çµåˆ
    if (params.toString()) {
        url += '&' + params.toString(); // â˜… ä¿®æ­£: æœ€åˆã® ?api=assets/scenes ã«ç¶šãã®ã§ & ã§çµåˆ
    }

    // APIã‚­ãƒ¼ã¯Serverless Functionå´ã§è¿½åŠ ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦
    const res = await fetch(url);
    if (!res.ok) {
        const errorData = await res.json();
        throw new Error(`API Error (${url}): ${res.status} - ${JSON.stringify(errorData)}`);
    }
    // APIãƒ«ãƒ¼ãƒˆã¯ã™ã§ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã¨ã—ã¦è¿”ã—ã¦ã„ã‚‹ãŸã‚ã€ãã®ã¾ã¾è¿”ã™
    const data = await res.json(); 
    
    // æˆ»ã‚Šå€¤ãŒé…åˆ—ã§ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    if (!Array.isArray(data)) {
        throw new Error(`API returned invalid data format. Expected an array but got: ${JSON.stringify(data)}`);
    }

    return data; // APIãƒ«ãƒ¼ãƒˆã‹ã‚‰è¿”ã•ã‚ŒãŸé…åˆ—ã‚’ãã®ã¾ã¾è¿”ã™
}


// --- ã‚·ãƒ¼ãƒ³è¡¨ç¤ºã¨ç·¨é›† ---

// ã‚·ãƒ¼ãƒ³ã‚’è¡¨ç¤º
function showScene(index) {
    if (currentEpisodeScenes.length === 0) {
        document.getElementById("scene-title").textContent = "ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãªã—";
        document.getElementById("speaker").textContent = "";
        document.getElementById("text").textContent = "ï¼ˆã“ã®è©±ã«ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚ï¼‰";
        backgroundElement.style.backgroundImage = `url('assets/default_bg.jpg')`;
        characterElement.style.display = 'none';
        specialImageElement.style.display = 'none';
        return;
    }

    if (index < 0 || index >= currentEpisodeScenes.length) {
        console.warn("ç„¡åŠ¹ãªã‚·ãƒ¼ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:", index);
        currentSceneIndex = Math.max(0, Math.min(index, currentEpisodeScenes.length - 1));
        showScene(currentSceneIndex);
        return;
    }
    currentSceneIndex = index;
    const s = currentEpisodeScenes[currentSceneIndex];

    document.getElementById("current-episode-display").textContent = `ç¬¬${s.episode || 'ä¸æ˜'}è©±`;
    document.getElementById("scene-title").textContent = `#${s.sceneNumber || (currentSceneIndex + 1)}`;
    document.getElementById("speaker").textContent = s.speaker || "è©±è€…ä¸æ˜";
    document.getElementById("text").textContent = s.text || "ï¼ˆã‚»ãƒªãƒ•ãªã—ï¼‰";

    // specialãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‡¦ç†
    const specialContent = s.special;
    let isSpecialImage = false; // specialãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸€æšçµµã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

    // specialContentãŒç‰¹æ®Šç”»åƒã‚¢ã‚»ãƒƒãƒˆã¨ã—ã¦å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (specialContent && loadedAssets.specialImages[specialContent]) {
        isSpecialImage = true;
    } else if (specialContent) {
        // specialContentãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æœè£…/å§¿åˆ‡ã‚Šæ›¿ãˆã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const parts = specialContent.split('_');
        const charTag = parts[0];
        const faceTag = parts.slice(1).join('_');
        if (loadedAssets.characters[charTag] && loadedAssets.characters[charTag][faceTag]) {
            isSpecialImage = false;
        }
    }


    if (isSpecialImage) {
        // ä¸€æšçµµãŒã‚ã‚‹å ´åˆ: èƒŒæ™¯ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã€ä¸€æšçµµã‚’è¡¨ç¤º
        backgroundElement.style.display = 'none';
        characterElement.style.display = 'none';
        specialImageElement.src = loadedAssets.specialImages[specialContent];
        specialImageElement.style.display = 'block';
        dialogueBox.style.height = '25%';
        dialogueBox.classList.remove('expanded');
    } else {
        // ä¸€æšçµµãŒãªã„å ´åˆ: é€šå¸¸ã®èƒŒæ™¯ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤º
        backgroundElement.style.display = 'block';
        specialImageElement.style.display = 'none';
        specialImageElement.src = "";

        // èƒŒæ™¯ç”»åƒã®è¨­å®š
        // â˜… ä¿®æ­£: item.backgroundã§ã¯ãªãã€s.backgroundã‚’ç›´æ¥URLã¨ã—ã¦ä½¿ã†
        const backgroundUrl = s.background; 
        if (backgroundUrl) {
            backgroundElement.style.backgroundImage = `url('${backgroundUrl}')`;
        } else {
            backgroundElement.style.backgroundImage = `url('assets/default_bg.jpg')`; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®è¨­å®š
        const charName = s.character || s.speaker;
        let actualFaceTag = s.face || 'normal';

        // specialãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æœè£…/å§¿åˆ‡ã‚Šæ›¿ãˆã®å ´åˆã€specialã®å†…å®¹ã‚’faceTagã¨ã—ã¦åˆ©ç”¨
        if (specialContent) {
            const parts = specialContent.split('_');
            const charTagFromSpecial = parts[0];
            const faceTagFromSpecial = parts.slice(1).join('_');
            // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã¨specialã‹ã‚‰å¾—ã‚‰ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åãŒä¸€è‡´ã—ã€
            // ãã®ç‰¹æ®Šãªè¡¨æƒ…ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«é©ç”¨
            if (charName === charTagFromSpecial && loadedAssets.characters[charName] && loadedAssets.characters[charName][faceTagFromSpecial]) {
                actualFaceTag = faceTagFromSpecial;
            }
        }

        const characterImageUrl = (charName && loadedAssets.characters[charName] && loadedAssets.characters[charName][actualFaceTag])
                                  ? loadedAssets.characters[charName][actualFaceTag]
                                  : 'assets/placeholder.png';

        characterElement.src = characterImageUrl;
        characterElement.style.display = (charName && charName !== "ãªã—") ? 'block' : 'none';
        characterElement.classList.toggle("dimmed", s.speaker === "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³");
    }

    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ã‚’æ›´æ–°
    document.getElementById("edit-speaker").value = s.speaker || "";
    document.getElementById("edit-text").value = s.text || "";
    document.getElementById("edit-face").value = s.face || "";
    // â˜… ä¿®æ­£: background ã¯APIã‹ã‚‰URLãŒæ¥ã‚‹ãŒã€edit-bg ã¯ã‚¿ã‚°åã‚’æœŸå¾…ã™ã‚‹ã®ã§ã€ãã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒå¿…è¦
    // ç¾çŠ¶ã¯ s.background ãŒURLã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€select ã® option value ã¨ä¸€è‡´ã—ãªã„
    // ã“ã“ã¯ã€loadedAssets.backgrounds ã‹ã‚‰ URL ã«å¯¾å¿œã™ã‚‹ã‚¿ã‚°ã‚’é€†å¼•ãã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€
    // ä¸€æ—¦ s.background (URL) ã‚’ç›´æ¥ã‚»ãƒƒãƒˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§é¸ã¶å½¢å¼ã«ã™ã‚‹
    // ã‚ã‚‹ã„ã¯ã€APIãƒ«ãƒ¼ãƒˆã§ background_tag ã®ã‚ˆã†ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã‹ã€‚
    // æœ€ã‚‚ç°¡å˜ãªã®ã¯ã€backgroundç·¨é›†ã¯ã‚¿ã‚°åã§ã€è¡¨ç¤ºã¯URLã¨ã„ã†ä½¿ã„åˆ†ã‘ã€‚
    // ã“ã®ã‚¨ãƒ‡ã‚£ã‚¿ã§èƒŒæ™¯ã‚’ç·¨é›†ã™ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¿ã‚°åã‚’çŸ¥ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
    // ãªã®ã§ã€edit-bg ã«ã¯ URL ã§ã¯ãªãã‚¿ã‚°åã‚’è¨­å®šã™ã‚‹ã®ãŒè‡ªç„¶ã€‚
    // ã—ã‹ã—ã€APIãƒ«ãƒ¼ãƒˆãŒURLã‚’è¿”ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã«URLã‚’è¨­å®šã™ã‚‹ã¨selectãŒåˆã‚ãªã„ã€‚
    // ä¸€æ™‚çš„ã« s.background ã®å€¤ãŒURLã®å ´åˆã€tagåã‚’ç‰¹å®šã™ã‚‹å‡¦ç†ãŒå¿…è¦ã€‚
    // ç°¡å˜åŒ–ã®ãŸã‚ã€ä¸€æ—¦ s.background ã‚’ãã®ã¾ã¾ã‚»ãƒƒãƒˆã™ã‚‹ãŒã€ã“ã“ã¯è¦æ¤œè¨
    // ç¾çŠ¶ã€populatedSelectOptions ã§ loadedAssets.backgrounds ã‹ã‚‰ã‚¿ã‚°ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ã®ã§ã€
    // ã“ã“ã§ s.background (URL) ã«å¯¾å¿œã™ã‚‹ã‚¿ã‚°ã‚’é€†å¼•ãã—ã¦ã‚»ãƒƒãƒˆã™ã‚‹ã€‚
    let currentBgTag = "";
    if (s.background) {
        for (const tag in loadedAssets.backgrounds) {
            if (loadedAssets.backgrounds[tag] === s.background) {
                currentBgTag = tag;
                break;
            }
        }
    }
    document.getElementById("edit-bg").value = currentBgTag || ""; // URLã‹ã‚‰ã‚¿ã‚°ã«å¤‰æ›ã—ã¦ã‚»ãƒƒãƒˆ

    document.getElementById("edit-special").value = s.special || "";

    if (useVoice && s.speaker !== "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³" && s.text) {
        speak(s.text);
    }
}


// ã‚·ãƒ¼ãƒ³ã®ç·¨é›†å†…å®¹ã‚’microCMSã«é©ç”¨ (ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«å¤‰æ›´)
async function applyEdits() {
    if (currentEpisodeScenes.length === 0) {
        alert("ç·¨é›†ã™ã‚‹ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    const s = currentEpisodeScenes[currentSceneIndex] || {};
    const originalSpeaker = s.speaker;

    s.speaker = document.getElementById("edit-speaker").value;
    s.text = document.getElementById("edit-text").value;
    s.face = document.getElementById("edit-face").value;
    // â˜… ä¿®æ­£: edit-bg ã¯ã‚¿ã‚°åãªã®ã§ã€APIã«é€ä¿¡ã™ã‚‹éš›ã¯ãã®ã‚¿ã‚°å
    s.background = document.getElementById("edit-bg").value; // ã“ã“ã¯ã‚¿ã‚°å

    s.special = document.getElementById("edit-special").value;

    try {
        const method = s.id ? 'PUT' : 'POST'; // GASã¯PATCHã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„ãŸã‚PUTã‚’ä½¿ç”¨
        // â˜… å¤‰æ›´ç‚¹: SCENES_PROXY_PATH ã¨ SPECIFIC_SCENE_PROXY_PATH ã®ä»£ã‚ã‚Šã«ç›´æ¥GAS URLã‚’æ§‹ç¯‰
        const url = s.id ? `${GAS_BASE_URL}?api=scenes&id=${s.id}` : `${GAS_BASE_URL}?api=scenes`;

        const dataToSend = {
            speaker: s.speaker,
            text: s.text,
            face: s.face,
            background: s.background, // ã“ã“ã¯ã‚¿ã‚°åã®ã¾ã¾ã§OK
            special: s.special,
            episode: s.episode,
            sceneNumber: s.sceneNumber,
        };

        const res = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dataToSend)
        });

        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(`API error! status: ${res.status}, message: ${JSON.stringify(errorData)}`);
        }

        if (method === 'POST') {
            const responseData = await res.json();
            s.id = responseData.id;
        }

        if (s.episode !== currentEpisodeNumber) {
            alert(`ã‚·ãƒ¼ãƒ³ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç•ªå·ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚\nç¾åœ¨ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚`);
            await loadEpisodeData(currentEpisodeNumber);
        } else {
            // â˜… ä¿®æ­£: æ›´æ–°å¾Œã«å†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
            await loadEpisodeData(currentEpisodeNumber); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
            const updatedIndex = currentEpisodeScenes.findIndex(scene => scene.id === s.id);
            if (updatedIndex !== -1) {
                currentSceneIndex = updatedIndex;
            } else {
                // ã‚·ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ˆé ­ã«
                currentSceneIndex = 0;
            }
            showScene(currentSceneIndex);
            collapseLog();
            if (originalSpeaker !== s.speaker) {
                populateSelectOptions();
            }
        }
        alert("ã‚·ãƒ¼ãƒ³ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");

    } catch (error) {
        console.error("ã‚·ãƒ¼ãƒ³ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        alert(`ã‚·ãƒ¼ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

// ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤æ©Ÿèƒ½ (ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«å¤‰æ›´)
async function deleteScene() {
    if (currentEpisodeScenes.length === 0) {
        alert("å‰Šé™¤ã™ã‚‹ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }
    if (!confirm("æœ¬å½“ã«ã“ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        return;
    }

    const s = currentEpisodeScenes[currentSceneIndex];
    if (!s || !s.id) {
        alert("ã“ã®ã‚·ãƒ¼ãƒ³ã¯ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ãªã„ã‹ã€IDãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }

    try {
        await deleteSceneFromMicroCMS(s.id);
        alert("ã‚·ãƒ¼ãƒ³ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚");
        await loadEpisodeData(currentEpisodeNumber);
        if (currentSceneIndex >= currentEpisodeScenes.length) {
            currentSceneIndex = Math.max(0, currentEpisodeScenes.length - 1);
        }
        showScene(currentSceneIndex);
        populateSelectOptions();
        collapseLog();
    } catch (error) {
        console.error("ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        alert(`ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

async function deleteSceneFromMicroCMS(sceneId) {
    // â˜… å¤‰æ›´ç‚¹: SCENES_PROXY_PATH ã¨ SPECIFIC_SCENE_PROXY_PATH ã®ä»£ã‚ã‚Šã«ç›´æ¥GAS URLã‚’æ§‹ç¯‰
    const res = await fetch(`${GAS_BASE_URL}?api=scenes&id=${sceneId}`, {
        method: 'DELETE',
    });
    if (!res.ok) {
        const errorData = await res.json();
        throw new Error(`API error during delete! status: ${res.status}, message: ${JSON.stringify(errorData)}`);
    }
}

// æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã®è¿½åŠ æ©Ÿèƒ½ (ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«å¤‰æ›´)
async function addScene() {
    // æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã® `episode` ã¨ `sceneNumber` ã‚’é©åˆ‡ã«è¨­å®š
    let newSceneNumber = 1;
    if (currentEpisodeScenes.length > 0) {
        // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®æ¬¡ã®ç•ªå·ã€ã¾ãŸã¯ç¾åœ¨ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®æœ€å¤§ã‚·ãƒ¼ãƒ³ç•ªå· + 1
        newSceneNumber = Math.max(...currentEpisodeScenes.map(s => s.sceneNumber || 0)) + 1;
    }

    const newScene = {
        speaker: "æ–°ã—ã„è©±è€…",
        text: "æ–°ã—ã„ã‚»ãƒªãƒ•",
        face: "",
        background: "default_bg", // åˆæœŸå€¤ã¯ã‚¿ã‚°å
        special: "",
        episode: currentEpisodeNumber, // ç¾åœ¨ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç•ªå·ã‚’ã‚»ãƒƒãƒˆ
        sceneNumber: newSceneNumber
    };

    try {
        // â˜… å¤‰æ›´ç‚¹: ãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¹ã‚’ä½¿ç”¨
        const res = await fetch(SCENES_PROXY_PATH, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newScene)
        });

        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(`API error! status: ${res.status}, message: ${JSON.stringify(errorData)}`);
        }
        const createdScene = await res.json(); // ä½œæˆã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã®æƒ…å ±ã‚’å–å¾—
        newScene.id = createdScene.id; // IDã‚’åæ˜ 

        await loadEpisodeData(currentEpisodeNumber); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿

        // è¿½åŠ ã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¦‹ã¤ã‘ã¦ç§»å‹•
        const addedIndex = currentEpisodeScenes.findIndex(scene => scene.id === newScene.id);
        if (addedIndex !== -1) {
            currentSceneIndex = addedIndex;
        } else {
            currentSceneIndex = currentEpisodeScenes.length - 1; // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€å¾Œã¸
        }
        showScene(currentSceneIndex);
        populateSelectOptions();
        expandLog();
        alert("æ–°ã—ã„ã‚·ãƒ¼ãƒ³ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼");
    } catch (error) {
        console.error("æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        alert(`æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}


// é¸æŠè‚¢ï¼ˆè©±è€…ã€è¡¨æƒ…ã€èƒŒæ™¯ï¼‰ã‚’å‹•çš„ã«ç”Ÿæˆ
function populateSelectOptions() {
    speakerSelect.innerHTML = '<option value="">--æœªé¸æŠ--</option>';
    faceSelect.innerHTML = '<option value="">--æœªé¸æŠ--</option>';
    bgSelect.innerHTML = '<option value="">--æœªé¸æŠ--</option>';

    const uniqueSpeakers = [...new Set(currentEpisodeScenes.map(s => s.speaker).filter(s => s && s !== "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"))].sort();
    uniqueSpeakers.forEach(speaker => {
        const option = document.createElement("option");
        option.value = speaker;
        option.textContent = speaker;
        speakerSelect.appendChild(option);
    });
    if (!uniqueSpeakers.includes("ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")) {
        const narrationOption = document.createElement("option");
        narrationOption.value = "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³";
        narrationOption.textContent = "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³";
        speakerSelect.appendChild(narrationOption);
    }

    const uniqueFaces = new Set();
    for (const charName in loadedAssets.characters) {
        for (const faceTag in loadedAssets.characters[charName]) {
            if (faceTag && faceTag !== 'default') uniqueFaces.add(faceTag);
        }
    }
    Array.from(uniqueFaces).sort().forEach(face => {
        const option = document.createElement("option");
        option.value = face;
        option.textContent = face;
        faceSelect.appendChild(option);
    });

    const uniqueBgs = new Set(Object.keys(loadedAssets.backgrounds));
    Array.from(uniqueBgs).sort().forEach(bg => {
        const option = document.createElement("option");
        option.value = bg;
        option.textContent = bg;
        bgSelect.appendChild(option);
    });
    if (!uniqueBgs.has("default_bg")) {
        const defaultBgOption = document.createElement("option");
        defaultBgOption.value = "default_bg";
        defaultBgOption.textContent = "default_bg (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)";
        bgSelect.appendChild(defaultBgOption);
    }

    const s = currentEpisodeScenes[currentSceneIndex];
    if (s) {
        speakerSelect.value = s.speaker || "";
        faceSelect.value = s.face || "";
        
        // â˜… ä¿®æ­£: edit-bg ã«ã¯ã‚¿ã‚°ã‚’è¨­å®šã™ã‚‹ã€‚s.backgroundã¯URLãªã®ã§é€†å¼•ã
        let currentBgTagForEdit = "";
        if (s.background) {
            for (const tag in loadedAssets.backgrounds) {
                if (loadedAssets.backgrounds[tag] === s.background) {
                    currentBgTagForEdit = tag;
                    break;
                }
            }
        }
        document.getElementById("edit-bg").value = currentBgTagForEdit || "";
    }
}

// --- é€²è¡ŒçŠ¶æ³ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿ ---
function saveProgress() {
    localStorage.setItem('yh_current_scene_index', currentSceneIndex);
    localStorage.setItem('yh_current_episode', currentEpisodeNumber);
    alert('é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
}

async function loadProgress() {
    const svIndex = localStorage.getItem('yh_current_scene_index');
    const svEpisode = localStorage.getItem('yh_current_episode');

    if (svEpisode !== null && !isNaN(parseInt(svEpisode)) && parseInt(svEpisode) > 0) {
        const episodeToLoad = parseInt(svEpisode);
        if (episodeToLoad !== currentEpisodeNumber) {
            alert(`ç¬¬${episodeToLoad}è©±ã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚`);
            await loadEpisodeData(episodeToLoad);
        }

        if (svIndex !== null && !isNaN(parseInt(svIndex))) {
            const indexToLoad = parseInt(svIndex);
            if (indexToLoad >= 0 && indexToLoad < currentEpisodeScenes.length) {
                currentSceneIndex = indexToLoad;
                showScene(currentSceneIndex);
                alert('ä¿å­˜åœ°ç‚¹ã‹ã‚‰å†é–‹ã—ã¾ã—ãŸã€‚');
            } else {
                alert('ä¿å­˜ã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ãªãŸã‚ã€è©±ã®æœ€åˆã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚');
                currentSceneIndex = 0;
                showScene(currentSceneIndex);
            }
        } else {
            alert('ä¿å­˜ã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€è©±ã®æœ€åˆã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚');
            currentSceneIndex = 0;
            showScene(currentSceneIndex);
        }
    } else {
        alert('æœ‰åŠ¹ãªä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
    }
    closeModal();
}

// --- éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½ ---
function toggleVoice() {
    useVoice = !useVoice;
    document.getElementById("voice-status").textContent = useVoice ? "ã‚ªãƒ³" : "ã‚ªãƒ•";
    alert('èª­ã¿ä¸Šã’ï¼š' + (useVoice ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•'));
}

function speak(txt) {
    if ('speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance(txt);
        msg.lang = 'ja-JP';
        speechSynthesis.cancel();
        speechSynthesis.speak(msg);
    } else {
        console.warn("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
    }
}

// --- UIæ“ä½œ ---
function expandLog() {
    document.getElementById('dialogue-box').classList.add('expanded');
}

function collapseLog() {
    document.getElementById('dialogue-box').classList.remove('expanded');
}

function openModal() {
    document.getElementById("modal").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
}

function showLoadingOverlay(show) {
    loadingOverlay.style.display = show ? 'flex' : 'none';
}

// --- ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç§»å‹• ---
async function changeEpisode(direction) {
    const nextEpisode = currentEpisodeNumber + direction;
    if (nextEpisode < 1) {
        alert("æœ€åˆã®è©±ã§ã™ã€‚");
        return;
    }
    await loadEpisodeData(nextEpisode);
}

// --- JSONãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«å¤‰æ›´) ---

async function downloadAllScenes() {
    showLoadingOverlay(true);
    try {
        // â˜… å¤‰æ›´ç‚¹: ãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¹ã‚’ä½¿ç”¨
        // episodeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«nullã‚’æ¸¡ã™ã“ã¨ã§ã€api/scenes.jsã®ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒ³ã‚’å–å¾—ã™ã‚‹
        const allNovelScenes = await fetchAllDataWithPagination(SCENES_PROXY_PATH, null); 
        if (allNovelScenes.length === 0) {
            alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        const blob = new Blob([JSON.stringify(allNovelScenes, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "all_scenes.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        alert("å…¨ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
    } catch (error) {
        console.error("å…¨ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        alert(`å…¨ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
    } finally {
        showLoadingOverlay(false);
    }
}

function uploadScenes() {
    document.getElementById('file-input').click();
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }
    showLoadingOverlay(true);
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const uploadedData = JSON.parse(e.target.result);
            if (!Array.isArray(uploadedData)) {
                throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸJSONã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
            }

            // â˜… å¤‰æ›´ç‚¹: ãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¹ã‚’ä½¿ç”¨
            // null ã‚’æ¸¡ã™ã“ã¨ã§å…¨ã‚·ãƒ¼ãƒ³ã‚’å–å¾—
            const existingMicroCMSSchemas = await fetchAllDataWithPagination(SCENES_PROXY_PATH, null);
            const existingIdMap = new Map(existingMicroCMSSchemas.map(s => [s.id, s]));

            const uploadedIds = new Set(uploadedData.map(s => s.id).filter(Boolean));

            for (const existingScene of existingMicroCMSSchemas) {
                if (!uploadedIds.has(existingScene.id)) {
                    await deleteSceneFromMicroCMS(existingScene.id);
                    console.log(`ã‚·ãƒ¼ãƒ³å‰Šé™¤: ${existingScene.id}`);
                }
            }

            for (const scene of uploadedData) {
                const method = existingIdMap.has(scene.id) ? 'PUT' : 'POST'; // GASã¯PATCHã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„ãŸã‚PUTã‚’ä½¿ç”¨
                // â˜… å¤‰æ›´ç‚¹: ãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¹ã‚’ä½¿ç”¨
                const url = method === 'PUT' ? `${GAS_BASE_URL}?api=scenes&id=${scene.id}` : `${GAS_BASE_URL}?api=scenes`;

                // background ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚¿ã‚°åã§é€ä¿¡ã•ã‚Œã‚‹ã¹ãã€‚
                // uploadã•ã‚ŒãŸJSONã® background ãŒURLã®å ´åˆã€ã“ã‚Œã‚’ã‚¿ã‚°ã«å¤‰æ›ã™ã‚‹ã‹ã€
                // ã‚ã‚‹ã„ã¯ upload API ãŒ URL ã‚’å—ã‘ä»˜ã‘ã¦ã‚¿ã‚°ã«å¤‰æ›ã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦ã€‚
                // ç¾çŠ¶ã¯ã€uploadedDataã® background ãŒã‚¿ã‚°åã§ã‚ã‚‹ã¨ä»®å®šã€‚
                const dataToSend = {
                    speaker: scene.speaker,
                    text: scene.text,
                    face: scene.face,
                    background: scene.background, 
                    special: scene.special,
                    episode: scene.episode || 1,
                    sceneNumber: scene.sceneNumber || 1
                };

                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`API error during upload (${method} ${url})! status: ${res.status}, message: ${JSON.stringify(errorData)}`);
                }
                console.log(`ã‚·ãƒ¼ãƒ³ ${method === 'PUT' ? 'æ›´æ–°' : 'è¿½åŠ '}: ID ${scene.id || 'æ–°è¦'}`);
            }

            alert("ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€Google Sheetsã«åŒæœŸã•ã‚Œã¾ã—ãŸï¼\nç¾åœ¨ã®è©±ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
            closeModal();
            await loadEpisodeData(currentEpisodeNumber);
        } catch (error) {
            console.error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONå½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
        } finally {
            showLoadingOverlay(false);
        }
    };
    reader.readAsText(file);
}

// --- ã‚¢ã‚»ãƒƒãƒˆä¸è¶³ãƒã‚§ãƒƒã‚¯ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ (ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«å¤‰æ›´) ---

// ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã€UIã‚’æ›´æ–°ã™ã‚‹
function checkMissingAssets() {
    missingAssets = []; // ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–

    // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚¢ã‚»ãƒƒãƒˆã‚’å…¨ã¦é›†ã‚ã‚‹ï¼ˆé‡è¤‡ãªã—ï¼‰
    const requiredBackgrounds = new Set();
    const requiredCharacters = new Map();
    const requiredSpecialImages = new Set();
    const requiredEffects = new Set();

    currentEpisodeScenes.forEach(scene => {
if (scene.background && scene.background !== "ãªã—" && !scene.background.startsWith('http://') && !scene.background.startsWith('https://')) {
            // background ãŒã‚¿ã‚°æ–‡å­—åˆ—ã®å ´åˆï¼ˆä¾‹: default_bgï¼‰
            requiredBackgrounds.add(scene.background);
        } else if (scene.background && scene.background.startsWith('http')) {
            // background ãŒ URL ã®å ´åˆã€å¯¾å¿œã™ã‚‹ã‚¿ã‚°ãŒã‚ã‚‹ã‹loadedAssets.backgroundsã‚’é€†å¼•ãã—ã¦ãƒã‚§ãƒƒã‚¯
            let foundTag = false;
            for (const tag in loadedAssets.backgrounds) {
                if (loadedAssets.backgrounds[tag] === scene.background) {
                    foundTag = true;
                    break;
                }
            }
            if (!foundTag) {
                // URLã¯å­˜åœ¨ã™ã‚‹ãŒloadedAssetsã«ãã®ã‚¿ã‚°ãŒãªã„å ´åˆ
                // ã“ã‚Œã¯ã€Œã‚¿ã‚°ãŒä¸æ˜ãªã‚¢ã‚»ãƒƒãƒˆã€ã¨ãªã‚‹ãŸã‚ã€ä¸è¶³ã¨ã¯ç•°ãªã‚‹ãŒã€
                // ä¸€æ—¦ã€Œä¸è¶³ã€ã¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çŸ¥ã‚‰ã›ã‚‹ãŸã‚ã€URLè‡ªä½“ã‚’ã‚¿ã‚°ã¨ã—ã¦æ‰±ã†
                console.warn("APIã‹ã‚‰ç›´æ¥URLãŒè¿”ã•ã‚ŒãŸãŒã€å¯¾å¿œã™ã‚‹ã‚¿ã‚°ãŒloadedAssetsã«ã‚ã‚Šã¾ã›ã‚“:", scene.background);
                // ã“ã“ã§ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆã¨ã—ã¦æ‰±ã†ã‹ã¯æ¤œè¨ã®ä½™åœ°ã‚ã‚Šã€‚ä»Šå›ã¯ä¸€æ—¦ã‚¿ã‚°ã¨ã—ã¦è¿½åŠ ã—ã¦ãƒã‚§ãƒƒã‚¯
                // ï¼ˆãŸã ã—ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆã¨ãªã‚‹ã‚¿ã‚°åãŒä¸æ˜ãªãŸã‚ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã§ããªã„ï¼‰
                // å®Ÿéš›ã«ã¯ã€APIå´ãŒå¸¸ã«ã‚¿ã‚°ã‚’è¿”ã™ã‹ã€URLã¨ã‚¿ã‚°ä¸¡æ–¹ã‚’è¿”ã™ã®ãŒç†æƒ³
                // ã“ã“ã§ã¯ã€`background`ãŒURLã§ã‚ã£ã¦ã‚‚ã€å¯¾å¿œã™ã‚‹ã‚¿ã‚°ãŒ`loadedAssets.backgrounds`ã«å­˜åœ¨ã—ãªã„å ´åˆã¯ã€
                // `populateMissingAssetSelect`ã§ã‚¿ã‚°åãŒURLã«ãªã£ã¦ã—ã¾ã†ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã•ã›ã‚‹ãŸã‚è¿½åŠ 
                requiredBackgrounds.add(scene.background); // URLè‡ªä½“ã‚’ã‚¿ã‚°ã¨ã—ã¦è¿½åŠ 
            }
        }


        const charName = scene.character || scene.speaker;
        if (charName && charName !== "ãªã—" && charName !== "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³") {
            let actualFaceTag = scene.face || 'normal';
            // specialãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æœè£…/å§¿åˆ‡ã‚Šæ›¿ãˆã®å ´åˆ
            if (scene.special) {
                const parts = scene.special.split('_');
                const specialCharTag = parts[0];
                const specialFaceTag = parts.slice(1).join('_');
                if (charName === specialCharTag) {
                    actualFaceTag = specialFaceTag;
                }
            }
            if (!requiredCharacters.has(charName)) {
                requiredCharacters.set(charName, new Set());
            }
            requiredCharacters.get(charName).add(actualFaceTag);
        }

        if (scene.special && scene.special !== "ãªã—") {
            const parts = scene.special.split('_');
            const specialCharTag = parts[0];
            const specialFaceTag = parts.slice(1).join('_');

            if (!(loadedAssets.characters[specialCharTag] && loadedAssets.characters[specialCharTag][specialFaceTag])) {
                 requiredSpecialImages.add(scene.special);
            }
        }
        if (scene.effect && scene.effect !== "ãªã—") {
            requiredEffects.add(scene.effect);
        }
    });

    // ä¸è¶³ã—ã¦ã„ã‚‹èƒŒæ™¯ã‚’`missingAssets`ã«è¿½åŠ 
    requiredBackgrounds.forEach(tag => {
        // loadedAssets.backgrounds[tag] ã« URL ãŒå«ã¾ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        // APIã‹ã‚‰è¿”ã•ã‚ŒãŸURLã«å¯¾å¿œã™ã‚‹ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚ä¸è¶³ã¨ã¿ãªã™
        if (!loadedAssets.backgrounds[tag]) {
            // ã“ã“ã§ tag ãŒ URL ã®å ´åˆã¯ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ããªã„ã®ã§æ³¨æ„ãŒå¿…è¦
            missingAssets.push({ tag: tag, type: 'background' });
        }
    });

    // ä¸è¶³ã—ã¦ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’`missingAssets`ã«è¿½åŠ 
    requiredCharacters.forEach((faceTags, charName) => {
        faceTags.forEach(faceTag => {
            if (!loadedAssets.characters[charName] || !loadedAssets.characters[charName][faceTag]) {
                missingAssets.push({ tag: `${charName}_${faceTag}`, type: 'character' });
            }
        });
    });

    // ä¸è¶³ã—ã¦ã„ã‚‹ç‰¹æ®Šç”»åƒã‚’`missingAssets`ã«è¿½åŠ 
    requiredSpecialImages.forEach(tag => {
        if (!loadedAssets.specialImages[tag]) {
            missingAssets.push({ tag: tag, type: 'special_image' });
        }
    });

    // ä¸è¶³ã—ã¦ã„ã‚‹åŠ¹æœéŸ³ã‚’`missingAssets`ã«è¿½åŠ 
    requiredEffects.forEach(tag => {
        if (!loadedAssets.effects[tag]) {
            missingAssets.push({ tag: tag, type: 'effect' });
        }
    });


    // ã‚½ãƒ¼ãƒˆï¼ˆè¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
    missingAssets.sort((a, b) => {
        if (a.type !== b.type) {
            return a.type.localeCompare(b.type);
        }
        return a.tag.localeCompare(b.tag);
    });

    // UIã®æ›´æ–°
    updateMissingAssetsIndicator();
    populateMissingAssetSelect();
}

// ã³ã£ãã‚Šãƒãƒ¼ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
function updateMissingAssetsIndicator() {
    if (missingAssets.length > 0) {
        missingAssetsIndicator.style.display = 'block';
    } else {
        missingAssetsIndicator.style.display = 'none';
    }
}

// ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
function populateMissingAssetSelect() {
    missingAssetSelect.innerHTML = '';
    if (missingAssets.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "--ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆãªã—--";
        missingAssetSelect.appendChild(option);
        missingAssetSelect.disabled = true;
    } else {
        missingAssetSelect.disabled = false;
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "â–¼ ã‚¢ã‚»ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„";
        missingAssetSelect.appendChild(defaultOption);

        missingAssets.forEach(asset => {
            const option = document.createElement('option');
            // è¡¨ç¤ºå
            let displayName = asset.tag;
            if (asset.type === 'background') displayName = `èƒŒæ™¯: ${asset.tag}`;
            else if (asset.type === 'character') displayName = `ã‚­ãƒ£ãƒ©: ${asset.tag.replace('_', ' (')})`;
            else if (asset.type === 'special_image') displayName = `ç‰¹æ®Š: ${asset.tag}`;
            else if (asset.type === 'effect') displayName = `åŠ¹æœéŸ³: ${asset.tag}`; // åŠ¹æœéŸ³ã®è¡¨ç¤ºåã‚‚è¿½åŠ 

            option.value = `${asset.type}:${asset.tag}`;
            option.textContent = displayName;
            missingAssetSelect.appendChild(option);
        });
    }
}

// ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openAssetUploadModal() {
    populateMissingAssetSelect();
    document.getElementById("asset-upload-modal").style.display = "flex";
    document.getElementById("upload-single-asset-file").value = "";
}

// ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeAssetUploadModal() {
    document.getElementById("asset-upload-modal").style.display = "none";
}

// å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† (ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã«å¤‰æ›´)
async function handleSingleAssetUpload() {
    const selectedValue = missingAssetSelect.value;
    const fileInput = document.getElementById('upload-single-asset-file');
    const file = fileInput.files[0];

    if (!selectedValue) {
        alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ä¸è¶³ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
    }
    if (!file) {
        alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    const [assetType, assetTag] = selectedValue.split(':');

    // â˜… ä¿®æ­£: assetTag ãŒURLã®å ´åˆã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ããªã„ãŸã‚è­¦å‘Š
    if (assetTag.startsWith('http://') || assetTag.startsWith('https://')) {
        alert("URLå½¢å¼ã®èƒŒæ™¯ã‚¢ã‚»ãƒƒãƒˆã¯ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚MicroCMSã®ç®¡ç†ç”»é¢ã§URLã«å¯¾å¿œã™ã‚‹ã‚¿ã‚°ã‚’æŒã¤ã‚¢ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    showLoadingOverlay(true);

    try {
        // GASã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã€ã“ã“ã§ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™ã ã‘ã§ã™ã€‚
        // å®Ÿéš›ã«ã¯ã€ã“ã®éƒ¨åˆ†ã¯Google Driveã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãªã©ã€åˆ¥ã®å‡¦ç†ãŒå¿…è¦ã§ã™ã€‚
        alert("GASã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ç”»åƒã‚’åˆ¥ã®å ´æ‰€ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãã®URLã‚’æ‰‹å‹•ã§ã‚¢ã‚»ãƒƒãƒˆã¨ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
        console.error("GASã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return; // ã“ã“ã§å‡¦ç†ã‚’ä¸­æ–­

        // ä»¥ä¸‹ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ã€URLãŒå–å¾—ã§ããŸå ´åˆã«ç¶šãå‡¦ç†ã®ä¾‹ã§ã™ã€‚
        // // 1. microCMSã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (ãƒ—ãƒ­ã‚­ã‚·çµŒç”±)
        // const formData = new FormData();
        // formData.append('file', file);

        // const uploadRes = await fetch(UPLOAD_PROXY_PATH, { // ãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¹ã‚’ä½¿ç”¨
        //     method: 'POST',
        //     body: formData
        // });

        // if (!uploadRes.ok) {
        //     const errorData = await uploadRes.json();
        //     throw new Error(`Upload failed for ${file.name}: ${JSON.stringify(errorData)}`);
        // }
        // const uploadedFile = await uploadRes.json();
        // const uploadedFileUrl = uploadedFile.url;

        // let dataToRegister = {
        //     asset_type: [assetType], // â˜… ä¿®æ­£: asset_type ã‚’é…åˆ—å½¢å¼ã§æ¸¡ã™
        //     tag: assetTag,
        // };

        // if (assetType === 'background' || assetType === 'special_image' || assetType === 'effect') { // â˜… ä¿®æ­£: effectã‚‚imageãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç›´æ¥
        //     dataToRegister.image = { url: uploadedFileUrl };
        // } else if (assetType === 'character') {
        //     const parts = assetTag.split('_');
        //     dataToRegister.tag = parts[0];
        //     dataToRegister.character_face_tag = parts.slice(1).join('_') || 'default';
        //     dataToRegister.image = { url: uploadedFileUrl }; // â˜… ä¿®æ­£: character_face_image ã‚’ image ã«å¤‰æ›´
        // }

        // // 2. assets APIã«ç™»éŒ² (ãƒ—ãƒ­ã‚­ã‚·çµŒç”±)
        // const registerRes = await fetch(ASSETS_PROXY_PATH, { // ãƒ—ãƒ­ã‚­ã‚·ãƒ‘ã‚¹ã‚’ä½¿ç”¨
        //     method: 'POST',
        //     headers: {
        //         'Content-Type': 'application/json',
        //     },
        //     body: JSON.stringify(dataToRegister)
        // });

        // if (!registerRes.ok) {
        //     const errorData = await registerRes.json();
        //     throw new Error(`Asset registration failed for ${assetTag}: ${JSON.stringify(errorData)}`);
        // }

        // alert(`ã‚¢ã‚»ãƒƒãƒˆã€Œ${assetTag}ã€ã‚’æ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ç™»éŒ²ã—ã¾ã—ãŸï¼`);
        // closeAssetUploadModal();
        // await loadEpisodeData(currentEpisodeNumber);
    } catch (error) {
        console.error(`ã‚¢ã‚»ãƒƒãƒˆã€Œ${assetTag}ã€ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
        alert(`ã‚¢ã‚»ãƒƒãƒˆã€Œ${assetTag}ã€ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
    } finally {
        showLoadingOverlay(false);
    }
}


// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
const dialogueBox = document.getElementById('dialogue-box');
let startY = 0, startX = 0, touchStartTime = 0;

dialogueBox.addEventListener('touchstart', e => {
    startY = e.touches[0].clientY;
    startX = e.touches[0].clientX;
    touchStartTime = Date.now();
});

dialogueBox.addEventListener('touchend', e => {
    const endY = e.changedTouches[0].clientY;
    const endX = e.changedTouches[0].clientX;
    const dy = startY - endY;
    const dx = startX - endX;
    const dt = Date.now() - touchStartTime;

    const isExpanded = dialogueBox.classList.contains('expanded');

    if (dy > 50 && Math.abs(dx) < 50 && dt < 300 && !isExpanded) {
        expandLog();
        return;
    }
    if (endY - startY > 50 && Math.abs(dx) < 50 && dt < 300 && isExpanded) {
        collapseLog();
        return;
    }
    if (Math.abs(dy) < 10 && Math.abs(dx) < 10 && dt >= 500) {
        if (isExpanded) {
            collapseLog();
        } else {
            expandLog();
        }
        return;
    }
});

document.body.addEventListener('click', e => {
    if (document.getElementById("modal").style.display === "flex" ||
        document.getElementById("asset-upload-modal").style.display === "flex" ||
        dialogueBox.classList.contains('expanded')) {
        return;
    }

    if (e.target.closest('#edit-form') || e.target.closest('#controls') || e.target.closest('#header')) {
        return;
    }

    const x = e.clientX;
    const w = window.innerWidth;

    if (x < w / 3) {
        currentSceneIndex--;
    } else if (x > w * 2 / 3) {
        currentSceneIndex++;
    } else {
        expandLog();
        return;
    }

    currentSceneIndex = Math.max(0, Math.min(currentSceneIndex, currentEpisodeScenes.length - 1));
    showScene(currentSceneIndex);
});
</script>
</body>
</html>