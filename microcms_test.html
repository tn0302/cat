<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>勇者ハーレム - ノベルビューア（編集モード）</title>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        #header { height: 48px; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: space-between; padding: 0 12px; }
        #novel-container { position: relative; height: calc(100% - 48px); }
        #background, #special-image { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 0; }
        #special-image { object-fit: contain; background: none; } /* 一枚絵の場合 */
        #character { position: absolute; bottom: -10%; left: 50%; transform: translateX(-50%); max-height: 70%; max-width: 100%; object-fit: contain; z-index: 1; transition: filter 0.3s ease; }
        #character.dimmed { filter: brightness(0.5); }
        #dialogue-box {
            position: absolute; bottom: 0; width: 100%; min-height: 25%; max-height: 50%;
            background: rgba(0,0,0,0.8); padding: 20px; box-sizing: border-box; z-index: 10;
            display: flex; flex-direction: column; transition: all 0.3s ease;
            overflow: hidden; /* ログ展開時に隠れる部分 */
        }
        #dialogue-box.expanded {
            height: 100%; max-height: 100%;
            justify-content: flex-start; /* 展開時は上から */
            padding-bottom: 50px; /* 下部操作ボタンとの重なり回避 */
        }
        #speaker-name { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; color: #ffd700; }
        #dialogue-text { font-size: 1.1em; line-height: 1.5; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); user-select: text; /* テキスト選択可能に */ }
        #next-indicator { position: absolute; bottom: 10px; right: 20px; font-size: 2em; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        /* #controls styles removed as the element is being removed */

        .control-button { background: #333; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-size: 0.9em; }
        .control-button:hover { background: #555; }

        /* ログ表示スタイル */
       .log-entry { margin-bottom: 10px; }
        .log-speaker { font-weight: bold; color: #ffd700; margin-bottom: 2px; }
        .log-text { font-size: 1em; line-height: 1.4; }
    
        /* 編集フォームのモーダル */
        #modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        #edit-form-container { background: #222; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
        #edit-form label { display: block; margin-bottom: 5px; font-weight: bold; color: #eee; }
        #edit-form input[type="text"], #edit-form textarea, #edit-form select {
            width: calc(100% - 20px); padding: 10px; margin-bottom: 15px;
            border: 1px solid #555; border-radius: 4px; background-color: #333; color: #fff;
            font-size: 1em;
        }
        #edit-form textarea { resize: vertical; min-height: 80px; }
        #edit-form button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-right: 10px; }
        #edit-form button:hover { background: #0056b3; }
        #edit-form button.delete-button { background: #dc3545; }
        #edit-form button.delete-button:hover { background: #c82333; }
        #edit-form button.cancel-button { background: #6c757d; }
        #edit-form button.cancel-button:hover { background: #5a6268; }

        /* アセットアップロードモーダル */
        #asset-upload-modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        #asset-upload-form-container { background: #222; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-sizing: border-box; }
        #asset-upload-form input[type="text"], #asset-upload-form select, #asset-upload-form input[type="file"] {
            width: calc(100% - 20px); padding: 10px; margin-bottom: 15px;
            border: 1px solid #555; border-radius: 4px; background-color: #333; color: #fff;
            font-size: 1em;
        }
        #asset-upload-form button { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-right: 10px; }
        #asset-upload-form button:hover { background: #218838; }
        #asset-upload-form button.cancel-button { background: #6c757d; }
        #asset-upload-form button.cancel-button:hover { background: #5a6268; }

        /* ヘッダーのドロップダウン */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #333;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0; /* 右揃え */
            border-radius: 4px;
            overflow: hidden;
        }
        .dropdown-content button {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.9em;
        }
        .dropdown-content button:hover { background-color: #555; }
        .dropdown:hover .dropdown-content { display: block; }
        .dropbtn {
            background-color: #333;
            color: white;
            padding: 8px 12px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        .dropbtn:hover { background-color: #555; }

        /* エピソード選択ドロップダウン */
        #episode-select {
            padding: 5px 10px;
            border-radius: 4px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            font-size: 1em;
            margin-left: 10px;
            cursor: pointer;
        }
        #episode-select option {
            background-color: #333;
            color: white;
        }
    </style>
</head>
<body>
    <div id="header">
        <div style="display: flex; align-items: center;">
            <button id="prev-episode-button" class="control-button" style="margin-right: 5px;">前のエピソード</button>
            <select id="episode-select"></select>
            <button id="next-episode-button" class="control-button" style="margin-left: 5px;">次のエピソード</button>
        </div>
        <div class="dropdown">
            <button class="dropbtn">メニュー</button>
            <div class="dropdown-content">
                <button id="add-scene-button">シーン追加</button>
                <button id="edit-scene-button">シーン編集</button>
                <button id="delete-scene-button">シーン削除</button>
                <button id="upload-asset-button">不足アセットのアップロード</button>
                <button id="refresh-data-button">データ更新</button>
            </div>
        </div>
    </div>
    <div id="novel-container">
        <div id="background"></div>
        <img id="special-image" src="" alt="" style="display: none;">
        <img id="character" src="" alt="" style="display: none;">
        <img id="effect-image" src="" alt="" style="display: none;">

        <div id="dialogue-box">
            <div id="speaker-name"></div>
            <div id="dialogue-text"></div>
            <div id="next-indicator">▼</div>
        </div>

        </div>

    <div id="modal">
        <div id="edit-form-container">
            <h2 id="modal-title">シーン編集</h2>
            <form id="edit-form">
                <label for="edit-id">ID:</label>
                <input type="text" id="edit-id" name="id" readonly><br>

                <label for="edit-episode">エピソード:</label>
                <input type="text" id="edit-episode" name="episode"><br>

                <label for="edit-scene-number">シーン番号:</label>
                <input type="text" id="edit-scene-number" name="sceneNumber"><br>

                <label for="edit-speaker">話者:</label>
                <input type="text" id="edit-speaker" name="speaker" list="speakers-list">
                <datalist id="speakers-list"></datalist><br>

                <label for="edit-text">本文:</label>
                <textarea id="edit-text" name="text"></textarea><br>

                <label for="edit-face">表情:</label>
                <input type="text" id="edit-face" name="face" list="faces-list">
                <datalist id="faces-list"></datalist><br>

                <label for="edit-special">特殊:</label>
                <input type="text" id="edit-special" name="special" list="special-list">
                <datalist id="special-list"></datalist><br>

                <label for="edit-background">背景:</label>
                <input type="text" id="edit-background" name="background" list="backgrounds-list">
                <datalist id="backgrounds-list"></datalist><br>

                <label for="edit-effect">エフェクト:</label>
                <input type="text" id="edit-effect" name="effect" list="effects-list">
                <datalist id="effects-list"></datalist><br>

                <button type="submit" id="save-scene-button">保存</button>
                <button type="button" id="cancel-edit-button" class="cancel-button">キャンセル</button>
                <button type="button" id="confirm-delete-button" class="delete-button" style="display: none;">削除確定</button>
            </form>
        </div>
    </div>

    <div id="asset-upload-modal">
        <div id="asset-upload-form-container">
            <h2>アセットアップロード</h2>
            <form id="asset-upload-form">
                <label for="asset-type">アセットタイプ:</label>
                <select id="asset-type" name="asset_type" required>
                    <option value="">選択してください</option>
                    <option value="character">キャラクター</option>
                    <option value="background">背景</option>
                    <option value="special_image">特殊画像</option>
                    <option value="effect">エフェクト</option>
                </select><br>

                <label for="asset-tag">タグ:</label>
                <input type="text" id="asset-tag" name="tag" required><br>

                <label for="asset-character-face-tag">キャラクター表情タグ (キャラの場合のみ):</label>
                <input type="text" id="asset-character-face-tag" name="character_face_tag"><br>

                <label for="asset-image-url">画像URL:</label>
                <input type="text" id="asset-image-url" name="image" required><br>
                <button type="submit">アップロード</button>
                <button type="button" id="cancel-upload-button" class="cancel-button">キャンセル</button>
            </form>
        </div>
    </div>

    <script>
        // Google Apps Script WebアプリのデプロイURLをここに設定
        const GAS_BASE_URL = 'https://script.google.com/macros/s/AKfycbwAsItKeiZ7DGaDBex-cXYpKWfsiScBrNGf0cnHIuJEq-9x0PpaYisrw1KtetJ6ruu7/exec'; // 例: 'https://script.google.com/macros/s/AKfycb.../exec'

        // APIエンドポイント
        const SCENES_PROXY_PATH = `${GAS_BASE_URL}?api=scenes`;
        const ASSETS_PROXY_PATH = `${GAS_BASE_URL}?api=assets`;

        let currentEpisodeData = []; // 現在のエピソードの全シーンデータ
        let currentSceneIndex = 0; // 現在表示中のシーンのインデックス
        let loadedAssets = { backgrounds: {}, characters: {}, effects: {}, specialImages: {} }; // 読み込み済みアセット
        let allEpisodeNumbers = []; // 全エピソード番号

        // DOM要素の取得
        const dialogueText = document.getElementById('dialogue-text');
        const speakerName = document.getElementById('speaker-name');
        const nextIndicator = document.getElementById('next-indicator');
        const characterImg = document.getElementById('character');
        const backgroundDiv = document.getElementById('background');
        const specialImage = document.getElementById('special-image');
        const effectImage = document.getElementById('effect-image');
        const dialogueBox = document.getElementById('dialogue-box');
   
        // モーダル関連の要素
        const modal = document.getElementById('modal');
        const editForm = document.getElementById('edit-form');
        const modalTitle = document.getElementById('modal-title');
        const saveSceneButton = document.getElementById('save-scene-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');

        // アセットアップロードモーダル関連の要素
        const assetUploadModal = document.getElementById('asset-upload-modal');
        const assetUploadForm = document.getElementById('asset-upload-form');

        // イベントリスナー
        // Removed: document.getElementById('next-button').addEventListener('click', () => nextScene());
        // Removed: document.getElementById('prev-button').addEventListener('click', () => prevScene());
        
        document.getElementById('add-scene-button').addEventListener('click', () => openEditModal('add'));
        document.getElementById('edit-scene-button').addEventListener('click', () => openEditModal('edit'));
        document.getElementById('delete-scene-button').addEventListener('click', () => openEditModal('delete'));
        document.getElementById('cancel-edit-button').addEventListener('click', () => closeModal());
        confirmDeleteButton.addEventListener('click', () => deleteScene());
        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            applyEdits();
        });

        document.getElementById('upload-asset-button').addEventListener('click', () => openAssetUploadModal());
        document.getElementById('cancel-upload-button').addEventListener('click', () => closeAssetUploadModal());
        assetUploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            uploadAsset();
        });

        document.getElementById('refresh-data-button').addEventListener('click', () => {
            if (confirm('全てのデータを再読み込みしますか？現在のエピソードの変更は破棄されます。')) {
                const currentEpisode = document.getElementById('episode-select').value;
                initialize(parseInt(currentEpisode)); // 現在のエピソードを再読み込み
            }
        });

        document.getElementById('episode-select').addEventListener('change', (e) => {
            const selectedEpisode = parseInt(e.target.value);
            loadEpisodeData(selectedEpisode);
        });
        document.getElementById('prev-episode-button').addEventListener('click', () => changeEpisode(-1));
        document.getElementById('next-episode-button').addEventListener('click', () => changeEpisode(1));


        // タッチイベント用変数
        let touchStartTime;
        let startY;
        let startX;

        // スマホでのログ展開/閉じる
        dialogueBox.addEventListener('touchstart', e => {
            touchStartTime = Date.now();
            startY = e.touches[0].clientY;
            startX = e.touches[0].clientX;
        });

        dialogueBox.addEventListener('touchend', e => {
            const endY = e.changedTouches[0].clientY;
            const endX = e.changedTouches[0].clientX;
            const dy = startY - endY;
            const dx = startX - endX;
            const dt = Date.now() - touchStartTime;

            const isExpanded = dialogueBox.classList.contains('expanded');

            if (dy > 50 && Math.abs(dx) < 50 && dt < 300 && !isExpanded) {
                expandLog();
                return;
            }
            if (endY - startY > 50 && Math.abs(dx) < 50 && dt < 300 && isExpanded) {
                collapseLog();
                return;
            }
            if (Math.abs(dy) < 10 && Math.abs(dx) < 10 && dt >= 500) {
                if (isExpanded) {
                    collapseLog();
                } else {
                    expandLog();
                }
                return;
            }
        });

        document.body.addEventListener('click', e => {
            if (document.getElementById("modal").style.display === "flex" ||
                document.getElementById("asset-upload-modal").style.display === "flex" ||
                dialogueBox.classList.contains('expanded')) {
                return;
            }

            // Removed: e.target.closest('#controls')
            if (e.target.closest('#edit-form') || e.target.closest('#header')) {
                return;
            }

            nextScene(); // シーンを進める
        });

        function expandLog() {
            dialogueBox.classList.add('expanded');
            logArea.scrollTop = logArea.scrollHeight; // 最下部にスクロール
        }

        function collapseLog() {
            dialogueBox.classList.remove('expanded');
        }

        async function fetchAllDataWithPagination(proxyPath, episode = null, filters = '') {
            let url = proxyPath;
            const params = new URLSearchParams();

            // scenes_proxy_pathの場合のみepisodeを追加
            if (proxyPath === SCENES_PROXY_PATH && episode !== null) {
                params.append('episode', episode);
            }
            
            // filtersがあれば追加
            if (filters) {
                const filterParams = new URLSearchParams(filters);
                filterParams.forEach((value, key) => params.append(key, value));
            }
            
            // パラメータがあればURLに結合
            if (params.toString()) {
                // proxyPathが既に ? を含んでいれば & で結合、そうでなければ ? で結合
                url += (proxyPath.includes('?') ? '&' : '?') + params.toString();
            }

            const res = await fetch(url);
            if (!res.ok) {
                try {
                    const errorData = await res.json();
                    throw new Error(`API Error (${url}): ${res.status} - ${JSON.stringify(errorData)}`);
                } catch (jsonError) {
                    throw new Error(`API Error (${url}): ${res.status} - ${res.statusText}. Could not parse error JSON: ${jsonError.message}`);
                }
            }
            
            let data = await res.json();

            // ASSETS_PROXY_PATH からの応答には 'contents' ラッパーがあることを考慮する
            if (proxyPath === ASSETS_PROXY_PATH && data && typeof data === 'object' && 'contents' in data) {
                data = data.contents;
            }
            
            // 戻り値が配列でない場合のエラーハンドリング
            if (!Array.isArray(data)) {
                throw new Error(`API returned invalid data format. Expected an array but got: ${JSON.stringify(data)}`);
            }

            return data;
        }

        async function loadEpisodeData(episodeNumber) {
            try {
                // シーンデータを取得
                currentEpisodeData = await fetchAllDataWithPagination(SCENES_PROXY_PATH, episodeNumber);
                // sceneNumber でソート
                currentEpisodeData.sort((a, b) => a.sceneNumber - b.sceneNumber);

                // 必要なアセットタグを収集
                const requiredBackgroundTags = new Set();
                const requiredCharacterTags = new Set();
                const requiredFaceTags = new Set();
                const requiredSpecialTags = new Set();
                const requiredEffectTags = new Set();

                currentEpisodeData.forEach(s => {
                    if (s.background && !s.background_image) requiredBackgroundTags.add(s.background); // background_imageがなければタグを収集
                    if (s.speaker && !s.speaker_image) requiredCharacterTags.add(s.speaker); // speaker_imageがなければタグを収集
                    if (s.face && !s.speaker_image) requiredFaceTags.add(s.face); // speaker_imageがなければ表情タグも
                    if (s.special && !s.special_image) requiredSpecialTags.add(s.special); // special_imageがなければタグを収集
                    if (s.effect && !s.effect_image) requiredEffectTags.add(s.effect); // effect_imageがなければタグを収集
                });

                // 必要なアセットデータを読み込み、キャッシュに格納
                // （画像URLはシーンデータに含まれるが、編集UIのプルダウン等でアセットタグは引き続き必要）
                loadedAssets = { backgrounds: {}, characters: {}, effects: {}, specialImages: {} };

                // 背景
                if (requiredBackgroundTags.size > 0) {
                    const bgFilters = Array.from(requiredBackgroundTags).map(tag => `tag[equals]${tag}`).join('[or]');
                    const bgAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=asset_type[equals]background[and](${bgFilters})`);
                    bgAssets.forEach(asset => { 
                        if (asset.tag && asset.image) {
                            loadedAssets.backgrounds[asset.tag] = asset.image; // asset.image はGASから直接URLとして返る
                        }
                    });
                }
                
                // キャラクター (話者と表情)
                if (requiredCharacterTags.size > 0) {
                    const charFilters = Array.from(requiredCharacterTags).map(tag => `tag[equals]${tag}`).join('[or]');
                    const charAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=asset_type[equals]character[and](${charFilters})`);
                    charAssets.forEach(asset => { 
                        if (asset.tag && asset.image) {
                            loadedAssets.characters[asset.tag] = {
                                image: asset.image,
                                face_tags: asset.character_face_tag ? asset.character_face_tag.split(',').map(t => t.trim()) : []
                            };
                        }
                    });
                }
                // 表情アセット自体はキャラクターアセットの一部として取得されるため、別途フェッチは不要
                // ただし、表情タグのリストは`loadedAssets.characters`内の`face_tags`から構築する

                // 特殊画像
                if (requiredSpecialTags.size > 0) {
                    const specialFilters = Array.from(requiredSpecialTags).map(tag => `tag[equals]${tag}`).join('[or]');
                    const specialAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=asset_type[equals]special_image[and](${specialFilters})`);
                    specialAssets.forEach(asset => {
                        if (asset.tag && asset.image) {
                            loadedAssets.specialImages[asset.tag] = asset.image;
                        }
                    });
                }

                // エフェクト
                if (requiredEffectTags.size > 0) {
                    const effectFilters = Array.from(requiredEffectTags).map(tag => `tag[equals]${tag}`).join('[or]');
                    const effectAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, null, `filters=asset_type[equals]effect[and](${effectFilters})`);
                    effectAssets.forEach(asset => {
                        if (asset.tag && asset.image) {
                            loadedAssets.effects[asset.tag] = asset.image;
                        }
                    });
                }

                checkMissingAssets(); // 不足アセットのチェック
                populateSelectOptions(); // 編集フォームの選択肢を更新
                currentSceneIndex = 0; // シーンを最初に戻す
                showScene(currentEpisodeData[currentSceneIndex]);
                updateNavigationButtons();
                updateEpisodeSelect();

            } catch (error) {
                console.error("エピソードデータ読み込み中にエラーが発生しました:", error);
                dialogueText.textContent = `エピソード ${episodeNumber} のデータ読み込み中にエラーが発生しました: ${error.message}`;
                speakerName.textContent = "エラー";
                nextIndicator.style.display = 'none';
            }
        }

        function showScene(s) {
            if (!s) {
                console.warn("表示するシーンデータがありません。");
                speakerName.textContent = "終了";
                dialogueText.textContent = "これ以上シーンはありません。";
                nextIndicator.style.display = 'none';
                characterImg.style.display = 'none';
                backgroundDiv.style.backgroundImage = 'none';
                specialImage.style.display = 'none';
                effectImage.style.display = 'none';
                return;
            }

            // 話者名と本文
            speakerName.textContent = s.speaker || '';
            dialogueText.textContent = s.text || '';
            nextIndicator.style.display = 'block'; // 次へインジケーター表示

            // キャラクター画像設定
            if (s.speaker_image) { // シーンデータに直接画像URLがあればそれを使う
                characterImg.src = s.speaker_image;
                characterImg.style.display = 'block';
            } else if (s.speaker && loadedAssets.characters[s.speaker] && loadedAssets.characters[s.speaker].image) {
                // フォールバック: loadedAssetsから解決
                characterImg.src = loadedAssets.characters[s.speaker].image;
                characterImg.style.display = 'block';
            } else {
                characterImg.src = '';
                characterImg.style.display = 'none';
            }

            // 背景画像設定
            if (s.background_image) { // シーンデータに直接画像URLがあればそれを使う
                backgroundDiv.style.backgroundImage = `url(${s.background_image})`;
            } else if (s.background && loadedAssets.backgrounds[s.background]) {
                // フォールバック: loadedAssetsから解決
                backgroundDiv.style.backgroundImage = `url(${loadedAssets.backgrounds[s.background]})`;
            } else {
                backgroundDiv.style.backgroundImage = '';
            }
            
            // 特殊画像設定
            if (s.special_image) { // シーンデータに直接画像URLがあればそれを使う
                specialImage.src = s.special_image;
                specialImage.style.display = 'block';
            } else if (s.special && loadedAssets.specialImages[s.special]) {
                // フォールバック: loadedAssetsから解決
                specialImage.src = loadedAssets.specialImages[s.special];
                specialImage.style.display = 'block';
            } else {
                specialImage.src = '';
                specialImage.style.display = 'none';
            }

            // エフェクト画像設定
            if (s.effect_image) { // シーンデータに直接画像URLがあればそれを使う
                effectImage.src = s.effect_image;
                effectImage.style.display = 'block';
            } else if (s.effect && loadedAssets.effects[s.effect]) {
                // フォールバック: loadedAssetsから解決
                effectImage.src = loadedAssets.effects[s.effect];
                effectImage.style.display = 'block';
            } else {
                effectImage.src = '';
                effectImage.style.display = 'none';
            }

            // キャラクターの表情と特殊状態
            // 表情はキャラクターアセットのface_tagsと一致するかで判断
            let characterFaceClass = '';
            if (s.face && s.speaker && loadedAssets.characters[s.speaker] && loadedAssets.characters[s.speaker].face_tags.includes(s.face)) {
                characterFaceClass = `face-${s.face}`; // CSSクラスとして適用
            }
            characterImg.className = 'character'; // 基本クラスをリセット
            if (characterFaceClass) characterImg.classList.add(characterFaceClass);

            // キャラクターの特殊状態 (例: 暗くする、非表示など)
            // 'dimmed' クラスの適用
            if (s.special === 'dimmed') {
                characterImg.classList.add('dimmed');
            } else {
                characterImg.classList.remove('dimmed');
            }

            // ログの更新
            updateLog();
        }

        function nextScene() {
            collapseLog(); // ログを閉じる
            if (currentSceneIndex < currentEpisodeData.length - 1) {
                currentSceneIndex++;
                showScene(currentEpisodeData[currentSceneIndex]);
                updateNavigationButtons();
            } else {
                // エピソードの終わり。次のエピソードがあれば自動でロード
                const currentEpisode = parseInt(document.getElementById('episode-select').value);
                const currentEpisodeIndex = allEpisodeNumbers.indexOf(currentEpisode);
                if (currentEpisodeIndex < allEpisodeNumbers.length - 1) {
                    const nextEpisode = allEpisodeNumbers[currentEpisodeIndex + 1];
                    document.getElementById('episode-select').value = nextEpisode;
                    loadEpisodeData(nextEpisode);
                } else {
                    alert('これ以上シーンはありません。');
                }
            }
        }

        function prevScene() {
            collapseLog(); // ログを閉じる
            if (currentSceneIndex > 0) {
                currentSceneIndex--;
                showScene(currentEpisodeData[currentSceneIndex]);
                updateNavigationButtons();
            } else {
                // エピソードの最初。前のエピソードがあれば自動でロード
                const currentEpisode = parseInt(document.getElementById('episode-select').value);
                const currentEpisodeIndex = allEpisodeNumbers.indexOf(currentEpisode);
                if (currentEpisodeIndex > 0) {
                    const prevEpisode = allEpisodeNumbers[currentEpisodeIndex - 1];
                    document.getElementById('episode-select').value = prevEpisode;
                    loadEpisodeData(prevEpisode);
                } else {
                    alert('これ以上シーンはありません。');
                }
            }
        }

        function updateLog() {
            logArea.innerHTML = ''; // ログエリアをクリア
            for (let i = 0; i <= currentSceneIndex; i++) {
                const s = currentEpisodeData[i];
                if (s.text) {
                    const logEntry = document.createElement('div');
                    logEntry.classList.add('log-entry');
                    if (s.speaker) {
                        const logSpeaker = document.createElement('div');
                        logSpeaker.classList.add('log-speaker');
                        logSpeaker.textContent = s.speaker;
                        logEntry.appendChild(logSpeaker);
                    }
                    const logText = document.createElement('div');
                    logText.classList.add('log-text');
                    logText.textContent = s.text;
                    logEntry.appendChild(logText);
                    logArea.appendChild(logEntry);
                }
            }
            logArea.scrollTop = logArea.scrollHeight; // 最下部にスクロール
        }

        // 不足アセットのチェック
        function checkMissingAssets() {
            const missingAssets = [];
            currentEpisodeData.forEach(s => {
                // キャラクター画像 (speaker_imageがない場合にチェック)
                if (s.speaker && !s.speaker_image && (!loadedAssets.characters[s.speaker] || !loadedAssets.characters[s.speaker].image)) {
                    missingAssets.push(`キャラクター: ${s.speaker}`);
                }
                // 背景画像 (background_imageがない場合にチェック)
                if (s.background && !s.background_image && !loadedAssets.backgrounds[s.background]) {
                    missingAssets.push(`背景: ${s.background}`);
                }
                // 特殊画像 (special_imageがない場合にチェック)
                if (s.special && !s.special_image && !loadedAssets.specialImages[s.special]) {
                    missingAssets.push(`特殊画像: ${s.special}`);
                }
                // エフェクト画像 (effect_imageがない場合にチェック)
                if (s.effect && !s.effect_image && !loadedAssets.effects[s.effect]) {
                    missingAssets.push(`エフェクト: ${s.effect}`);
                }
            });

            if (missingAssets.length > 0) {
                alert('不足しているアセットがあります:\n' + missingAssets.join('\n') + '\n「不足アセットのアップロード」から追加してください。');
            }
        }

        // 編集フォームの選択肢を更新
        function populateSelectOptions() {
            const speakersDatalist = document.getElementById('speakers-list');
            const facesDatalist = document.getElementById('faces-list');
            const backgroundsDatalist = document.getElementById('backgrounds-list');
            const specialDatalist = document.getElementById('special-list');
            const effectsDatalist = document.getElementById('effects-list');

            // 既存の選択肢をクリア
            speakersDatalist.innerHTML = '';
            facesDatalist.innerHTML = '';
            backgroundsDatalist.innerHTML = '';
            specialDatalist.innerHTML = '';
            effectsDatalist.innerHTML = '';

            // スピーカーの選択肢
            Object.keys(loadedAssets.characters).forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                speakersDatalist.appendChild(option);
            });

            // 表情の選択肢 (各キャラのアセットから収集)
            const uniqueFaces = new Set();
            Object.values(loadedAssets.characters).forEach(char => {
                char.face_tags.forEach(face => uniqueFaces.add(face));
            });
            Array.from(uniqueFaces).sort().forEach(face => {
                const option = document.createElement('option');
                option.value = face;
                facesDatalist.appendChild(option);
            });

            // 背景の選択肢
            Object.keys(loadedAssets.backgrounds).forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                backgroundsDatalist.appendChild(option);
            });

            // 特殊の選択肢
            Object.keys(loadedAssets.specialImages).forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                specialDatalist.appendChild(option);
            });

            // エフェクトの選択肢
            Object.keys(loadedAssets.effects).forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                effectsDatalist.appendChild(option);
            });
        }

        // 編集モーダルを開く
        function openEditModal(mode) {
            modal.style.display = 'flex';
            confirmDeleteButton.style.display = 'none'; // 削除ボタンはデフォルト非表示
            editForm.reset(); // フォームをリセット
            document.getElementById('edit-id').readOnly = (mode !== 'add'); // IDは追加時のみ編集可能

            if (mode === 'add') {
                modalTitle.textContent = 'シーン追加';
                saveSceneButton.textContent = '追加';
                // 新規追加の場合、現在のエピソードと次のシーン番号を自動入力
                document.getElementById('edit-episode').value = document.getElementById('episode-select').value;
                document.getElementById('edit-scene-number').value = currentEpisodeData.length > 0 ? Math.max(...currentEpisodeData.map(s => s.sceneNumber)) + 1 : 1;
            } else if (mode === 'edit') {
                modalTitle.textContent = 'シーン編集';
                saveSceneButton.textContent = '保存';
                // 現在のシーンデータをフォームにロード
                const currentScene = currentEpisodeData[currentSceneIndex];
                if (currentScene) {
                    for (const key in currentScene) {
                        const input = document.getElementById(`edit-${key}`);
                        if (input) input.value = currentScene[key];
                    }
                } else {
                    alert('編集するシーンがありません。');
                    closeModal();
                    return;
                }
            } else if (mode === 'delete') {
                modalTitle.textContent = 'シーン削除';
                saveSceneButton.textContent = '削除'; // ボタンテキストを「削除」に変更
                saveSceneButton.style.display = 'none'; // 削除時は保存ボタンを非表示に
                confirmDeleteButton.style.display = 'inline-block'; // 削除確定ボタンを表示
                // 現在のシーンデータをフォームにロード（読み取り専用）
                const currentScene = currentEpisodeData[currentSceneIndex];
                if (currentScene) {
                    for (const key in currentScene) {
                        const input = document.getElementById(`edit-${key}`);
                        if (input) {
                            input.value = currentScene[key];
                            input.readOnly = true; // 削除時は読み取り専用
                        }
                    }
                } else {
                    alert('削除するシーンがありません。');
                    closeModal();
                    return;
                }
            }
        }

        // モーダルを閉じる
        function closeModal() {
            modal.style.display = 'none';
            document.getElementById('edit-id').readOnly = false; // IDの読み取り専用を解除
            saveSceneButton.style.display = 'inline-block'; // 保存ボタンを再表示
        }

        // シーン編集・追加を適用
        async function applyEdits() {
            const formSceneData = {};
            const formData = new FormData(editForm);
            for (const [key, value] of formData.entries()) {
                formSceneData[key] = value;
            }

            // IDに基づいて追加か更新かを判断
            const isAdding = !document.getElementById('edit-id').value;
            const method = isAdding ? 'POST' : 'PUT';
            const url = isAdding ? SCENES_PROXY_PATH : `${SCENES_PROXY_PATH}&id=${formSceneData.id}`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formSceneData),
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`API Error: ${res.status} - ${JSON.stringify(errorData)}`);
                }

                alert(`シーンを${isAdding ? '追加' : '更新'}しました！`);
                closeModal();
                loadEpisodeData(parseInt(document.getElementById('episode-select').value)); // データを再読み込みして反映
            } catch (error) {
                console.error("シーン操作中にエラーが発生しました:", error);
                alert(`シーン操作に失敗しました: ${error.message}`);
            }
        }

        // シーンを削除
        async function deleteScene() {
            const sceneIdToDelete = document.getElementById('edit-id').value;
            if (!confirm(`ID: ${sceneIdToDelete} のシーンを本当に削除しますか？`)) {
                return;
            }

            try {
                const res = await fetch(`${SCENES_PROXY_PATH}&id=${sceneIdToDelete}`, {
                    method: 'DELETE',
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`API Error: ${res.status} - ${JSON.stringify(errorData)}`);
                }

                alert(`シーンID: ${sceneIdToDelete} を削除しました！`);
                closeModal();
                loadEpisodeData(parseInt(document.getElementById('episode-select').value)); // データを再読み込みして反映
            } catch (error) {
                console.error("シーン削除中にエラーが発生しました:", error);
                alert(`シーン削除に失敗しました: ${error.message}`);
            }
        }

        // アセットアップロードモーダルを開く
        function openAssetUploadModal() {
            assetUploadModal.style.display = 'flex';
            assetUploadForm.reset(); // フォームをリセット
        }

        // アセットアップロードモーダルを閉じる
        function closeAssetUploadModal() {
            assetUploadModal.style.display = 'none';
        }

        // アセットをアップロード (GAS API経由)
        async function uploadAsset() {
            const formData = new FormData(assetUploadForm);
            const assetData = {};
            for (const [key, value] of formData.entries()) {
                assetData[key] = value;
            }

            // 画像ファイルアップロード機能は現在のGASでは直接サポートされていないため、URLを直接入力させる
            if (!assetData.image) {
                alert('画像URLは必須です。');
                return;
            }

            try {
                const res = await fetch(ASSETS_PROXY_PATH, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(assetData),
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`API Error: ${res.status} - ${JSON.stringify(errorData)}`);
                }

                alert('アセットが正常にアップロードされました！');
                closeAssetUploadModal();
                // アセットデータを再読み込みし、UIを更新
                const currentEpisode = parseInt(document.getElementById('episode-select').value);
                initialize(currentEpisode); // アセットも再読み込みするためinitializeを呼ぶ
            } catch (error) {
                console.error("アセットアップロード中にエラーが発生しました:", error);
                alert(`アセットアップロードに失敗しました: ${error.message}`);
            }
        }

        // エピソード番号のリストを取得し、ドロップダウンを生成
        async function populateEpisodeSelect() {
            try {
                // 全シーンデータを取得し、ユニークなエピソード番号を抽出
                const allScenes = await fetchAllDataWithPagination(SCENES_PROXY_PATH);
                const episodeNumbers = new Set();
                allScenes.forEach(s => {
                    if (s.episode) {
                        episodeNumbers.add(parseInt(s.episode));
                    }
                });
                allEpisodeNumbers = Array.from(episodeNumbers).sort((a, b) => a - b);

                const episodeSelect = document.getElementById('episode-select');
                episodeSelect.innerHTML = ''; // 既存のオプションをクリア

                if (allEpisodeNumbers.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'エピソードなし';
                    episodeSelect.appendChild(option);
                    return;
                }

                allEpisodeNumbers.forEach(epNum => {
                    const option = document.createElement('option');
                    option.value = epNum;
                    option.textContent = `エピソード ${epNum}`;
                    episodeSelect.appendChild(option);
                });

                // URLパラメータからエピソードをロード、なければ最初のエピソード
                const urlParams = new URLSearchParams(window.location.search);
                const initialEpisode = parseInt(urlParams.get('episode')) || allEpisodeNumbers[0];
                if (allEpisodeNumbers.includes(initialEpisode)) {
                    episodeSelect.value = initialEpisode;
                } else {
                    episodeSelect.value = allEpisodeNumbers[0]; // デフォルトで最初のエピソードを選択
                }
                loadEpisodeData(parseInt(episodeSelect.value));

            } catch (error) {
                console.error("エピソード番号の取得中にエラーが発生しました:", error);
                alert(`エピソード番号の取得に失敗しました: ${error.message}`);
            }
        }

        // エピソードドロップダウンとボタンの状態を更新
        function updateEpisodeSelect() {
            const currentEpisode = parseInt(document.getElementById('episode-select').value);
            const episodeSelect = document.getElementById('episode-select');
            
            // ドロップダウンの選択を更新 (loadEpisodeDataで既に設定されているはずだが念のため)
            if (currentEpisode && allEpisodeNumbers.includes(currentEpisode)) {
                episodeSelect.value = currentEpisode;
            }
            updateNavigationButtons(); // エピソード切り替えボタンの表示/非表示を更新
        }

        // エピソード切り替えボタンの状態を更新
        function updateNavigationButtons() {
            const currentEpisode = parseInt(document.getElementById('episode-select').value);
            const currentEpisodeIndex = allEpisodeNumbers.indexOf(currentEpisode);

            document.getElementById('prev-episode-button').disabled = (currentEpisodeIndex <= 0);
            document.getElementById('next-episode-button').disabled = (currentEpisodeIndex >= allEpisodeNumbers.length - 1);

            // Removed: document.getElementById('prev-button').disabled = (currentSceneIndex <= 0);
            // Removed: document.getElementById('next-button').disabled = (currentSceneIndex >= currentEpisodeData.length - 1 && currentEpisodeIndex >= allEpisodeNumbers.length - 1);
        }

        // エピソードを切り替える
        function changeEpisode(direction) {
            const currentEpisode = parseInt(document.getElementById('episode-select').value);
            const currentEpisodeIndex = allEpisodeNumbers.indexOf(currentEpisode);
            const newEpisodeIndex = currentEpisodeIndex + direction;

            if (newEpisodeIndex >= 0 && newEpisodeIndex < allEpisodeNumbers.length) {
                const newEpisode = allEpisodeNumbers[newEpisodeIndex];
                document.getElementById('episode-select').value = newEpisode;
                loadEpisodeData(newEpisode);
            }
        }

        // 初期化処理
        async function initialize(initialEpisode = null) {
            // GAS_BASE_URLが設定されているか確認
            if (GAS_BASE_URL === 'YOUR_GAS_WEB_APP_URL_HERE' || !GAS_BASE_URL.startsWith('https://script.google.com/macros/s/')) {
                alert('GAS_BASE_URLが正しく設定されていません。`index.html`ファイル内の`YOUR_GAS_WEB_APP_URL_HERE`を、デプロイしたGAS WebアプリのURLに置き換えてください。');
                return;
            }
            await populateEpisodeSelect(); // 全エピソード番号をロードし、ドロップダウンを初期化
            // populateEpisodeSelect内でloadEpisodeDataが呼ばれるため、ここでは直接呼ばない
        }

        // ページロード時に初期化
        window.addEventListener('load', () => initialize());
    </script>
</body>
</html>