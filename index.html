<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å‹‡è€…ãƒãƒ¼ãƒ¬ãƒ  - ãƒãƒ™ãƒ«ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
    #header { height: 48px; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: space-between; padding: 0 12px; }
    #novel-container { position: relative; height: calc(100% - 48px); }
    #background { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 0; }
    #character { position: absolute; bottom: -10%; left: 50%; transform: translateX(-50%); height: 70%; z-index: 1; transition: filter 0.3s ease; }
    #character.dimmed { filter: brightness(40%) saturate(50%); }
    #dialogue-box { position: absolute; bottom: 0; width: 100%; height: 25%; background: rgba(0, 0, 0, 0.6); padding: 16px; z-index: 2; transition: height 0.3s ease; overflow: hidden; box-sizing: border-box; }
    #dialogue-box.expanded { height: 80%; overflow-y: auto; }
    #speaker { font-weight: bold; }
    #text { margin-top: 8px; line-height: 1.6; }
    #edit-form { display: none; }
    #dialogue-box.expanded #edit-form { display: block; margin-top: 12px; }
    label { display: block; margin-top: 8px; }
    select, textarea, input { width: 100%; margin-top: 4px; font-size: 14px; padding: 4px; box-sizing: border-box; }
    button { margin-top: 12px; padding: 6px 12px; background: #333; color: #fff; border: none; cursor: pointer; border-radius: 4px; }
    #close-log { display: none; position: absolute; top: 8px; right: 12px; font-size: 20px; cursor: pointer; z-index: 3; }
    #dialogue-box.expanded #close-log { display: block; }
    #modal {
      display: none; position: fixed; z-index: 10;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); justify-content: center; align-items: center;
    }
    #modal-content {
      background: #222; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;
      position: relative; /* Closeãƒœã‚¿ãƒ³ã®ä½ç½®æ±ºã‚ã®ãŸã‚ */
    }
    #modal-close {
      position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer;
    }
  </style>
</head>
<body>
<div id="header">
  <div id="scene-title">ç¬¬1è©±</div>
  <div id="controls">
    <button onclick="openModal()">âš™ï¸ è¨­å®š</button>
  </div>
</div>
<div id="novel-container">
  <div id="background"></div>
  <img id="character" src="" alt="" />
  <div id="dialogue-box">
    <div id="speaker"></div>
    <div id="text"></div>
    <div id="edit-form">
      <label>è©±è€…ï¼š<select id="edit-speaker"></select></label>
      <label>ã‚»ãƒªãƒ•ï¼š<textarea id="edit-text" rows="3"></textarea></label>
      <label>è¡¨æƒ…ï¼š<select id="edit-face"></select></label>
      <label>èƒŒæ™¯ï¼š<select id="edit-bg"></select></label>
      <label>ç‰¹æ®Šï¼š<input type="text" id="edit-special" placeholder="ç‰¹æ®ŠåŠ¹æœã‚„ãƒ•ãƒ©ã‚°ãªã©" /></label>
      <button onclick="applyEdits()">âœ… é©ç”¨</button>
      <button onclick="deleteScene()" style="background: #a00; margin-left: 8px;">ğŸ—‘ï¸ ã“ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤</button>
      <button onclick="addScene()" style="background: #0a0; margin-left: 8px;">â• ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ </button>
    </div>
    <div id="close-log" onclick="collapseLog()">âœ•</div>
  </div>
</div>
<div id="modal">
  <div id="modal-content">
    <div id="modal-close" onclick="closeModal()">âœ•</div>
    <h2>è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    <button onclick="saveProgress()">ğŸ’¾ é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜</button><br><br>
    <button onclick="loadProgress()">ğŸ“‚ ç¶šãã‹ã‚‰å†é–‹</button><br><br>
    <button onclick="toggleVoice()">ğŸ”Š èª­ã¿ä¸Šã’: <span id="voice-status">ã‚ªãƒ•</span></button><br><br>
    <button onclick="downloadScenes()">â¬‡ï¸ scenes.json ã‚’ä¿å­˜</button><br><br>
    <button onclick="uploadScenes()">â¬†ï¸ scenes.json ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button><br><br>
    <a href="assets_editor.html" target="_blank">ğŸ–¼ï¸ ã‚¢ã‚»ãƒƒãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
  </div>
</div>

<input type="file" id="file-input" style="display: none;" accept=".json" onchange="handleFileUpload(event)">

<script>
let scenes = [], currentScene = 0, useVoice = false;
const apiBase = "https://nvw9sy9y9b.microcms.io/api/v1/scenes";
const apiKey = "fA7lEFFe3cPFr0zfmbnhckYWS79QT2QKdFiy"; // â† ã‚ãªãŸã®microCMS APIã‚­ãƒ¼

// microCMSã‹ã‚‰ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
async function loadScenes() {
  try {
    const res = await fetch(apiBase + "?limit=100", { // limitã‚’å¢—ã‚„ã—ã€ã‚ˆã‚Šå¤šãã®ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰
      headers: { 'X-API-KEY': apiKey }
    });
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    scenes = data.contents.sort((a, b) => a.episode - b.episode || a.scene - b.scene); // ã‚·ãƒ¼ãƒ³ã‚’ã‚½ãƒ¼ãƒˆ
    if (scenes.length === 0) {
      alert("ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
      addScene(); // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æœ€åˆã®ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ 
      return;
    }
    showScene(currentScene);
    populateSelectOptions(); // è©±è€…ã€è¡¨æƒ…ã€èƒŒæ™¯ã®é¸æŠè‚¢ã‚’åˆæœŸåŒ–
  } catch (error) {
    console.error("ã‚·ãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    alert("ã‚·ãƒ¼ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

// ã‚·ãƒ¼ãƒ³ã®ç·¨é›†å†…å®¹ã‚’microCMSã«é©ç”¨
async function applyEdits() {
  const s = scenes[currentScene];
  const originalSpeaker = s.speaker; // å¤‰æ›´å‰ã®è©±è€…ã‚’ä¿æŒ

  // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—
  s.speaker = document.getElementById("edit-speaker").value;
  s.text = document.getElementById("edit-text").value;
  s.face = document.getElementById("edit-face").value;
  s.background = document.getElementById("edit-bg").value;
  s.special = document.getElementById("edit-special").value;

  try {
    const method = s.id ? 'PATCH' : 'POST'; // æ—¢å­˜ã®ã‚·ãƒ¼ãƒ³ãªã‚‰PATCHã€æ–°è¦ãªã‚‰POST
    const url = s.id ? `${apiBase}/${s.id}` : apiBase;
    
    // microCMSã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ (ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯é€ã‚‰ãªã„)
    const dataToSend = {
      speaker: s.speaker,
      text: s.text,
      face: s.face,
      background: s.background,
      special: s.special,
      episode: s.episode || 1, // æ–°è¦ã‚·ãƒ¼ãƒ³ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      sceneNumber: s.sceneNumber || scenes.length // æ–°è¦ã‚·ãƒ¼ãƒ³ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    };

    const res = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-API-KEY': apiKey
      },
      body: JSON.stringify(dataToSend)
    });

    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(`API error! status: ${res.status}, message: ${JSON.stringify(errorData)}`);
    }

    // æ–°è¦ä½œæˆã®å ´åˆã¯IDã‚’æ›´æ–°
    if (method === 'POST') {
      const responseData = await res.json();
      s.id = responseData.id;
    }

    showScene(currentScene);
    collapseLog();
    // è©±è€…ãŒå¤‰ã‚ã£ãŸå ´åˆã€é¸æŠè‚¢ã‚’å†æ§‹ç¯‰
    if (originalSpeaker !== s.speaker) {
      populateSelectOptions();
    }
    alert("ã‚·ãƒ¼ãƒ³ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
  } catch (error) {
    console.error("ã‚·ãƒ¼ãƒ³ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    alert("ã‚·ãƒ¼ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

// ã‚·ãƒ¼ãƒ³ã‚’è¡¨ç¤º
function showScene(index) {
  if (index < 0 || index >= scenes.length) {
    console.warn("ç„¡åŠ¹ãªã‚·ãƒ¼ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:", index);
    return;
  }
  currentScene = index;
  const s = scenes[currentScene];

  document.getElementById("scene-title").textContent = `ç¬¬${s.episode || 'ä¸æ˜'}è©± #${s.sceneNumber || (currentScene + 1)}`;
  document.getElementById("speaker").textContent = s.speaker || "è©±è€…ä¸æ˜";
  document.getElementById("text").textContent = s.text || "ï¼ˆã‚»ãƒªãƒ•ãªã—ï¼‰";
  document.getElementById("background").style.backgroundImage = `url('assets/${s.background || 'default_bg'}.jpg')`;
  
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒãŒå­˜åœ¨ã—ãªã„å ´åˆã®å‡¦ç†ã‚’å¼·åŒ–
  const characterImage = s.character && s.character !== "ãªã—" ? `assets/${s.character}.png` : '';
  const characterElement = document.getElementById("character");
  characterElement.src = characterImage || "assets/placeholder.png"; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒãŒãªã„å ´åˆã¯placeholder
  characterElement.style.display = characterImage ? 'block' : 'none'; // ç”»åƒãŒãªã„å ´åˆã¯éè¡¨ç¤º
  
  document.getElementById("character").classList.toggle("dimmed", s.speaker === "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³");

  // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ã‚’æ›´æ–°
  document.getElementById("edit-speaker").value = s.speaker || "";
  document.getElementById("edit-text").value = s.text || "";
  document.getElementById("edit-face").value = s.face || "";
  document.getElementById("edit-bg").value = s.background || "";
  document.getElementById("edit-special").value = s.special || "";

  if (useVoice && s.speaker !== "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³" && s.text) {
    speak(s.text);
  }
}

// é¸æŠè‚¢ï¼ˆè©±è€…ã€è¡¨æƒ…ã€èƒŒæ™¯ï¼‰ã‚’å‹•çš„ã«ç”Ÿæˆ
function populateSelectOptions() {
  const speakerSelect = document.getElementById("edit-speaker");
  const faceSelect = document.getElementById("edit-face");
  const bgSelect = document.getElementById("edit-bg");

  // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
  speakerSelect.innerHTML = '<option value="">æœªé¸æŠ</option>';
  faceSelect.innerHTML = '<option value="">æœªé¸æŠ</option>';
  bgSelect.innerHTML = '<option value="">æœªé¸æŠ</option>';

  // ç¾æ™‚ç‚¹ã§ã®å…¨ã‚·ãƒ¼ãƒ³ã‹ã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè©±è€…åã‚’å–å¾—
  const uniqueSpeakers = [...new Set(scenes.map(s => s.speaker).filter(Boolean))].sort();
  uniqueSpeakers.forEach(speaker => {
    const option = document.createElement("option");
    option.value = speaker;
    option.textContent = speaker;
    speakerSelect.appendChild(option);
  });
  
  // å¿…è¦ã«å¿œã˜ã¦ã€è¡¨æƒ…ã‚„èƒŒæ™¯ã‚‚åŒæ§˜ã«å‹•çš„ã«ç”Ÿæˆ
  // ä»Šã¯ä»®ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
  const sampleFaces = ["é€šå¸¸", "ç¬‘é¡”", "æ€’ã‚Š", "æ‚²ã—ã¿"];
  sampleFaces.forEach(face => {
    const option = document.createElement("option");
    option.value = face;
    option.textContent = face;
    faceSelect.appendChild(option);
  });

  const sampleBgs = ["forest", "town", "castle", "room"];
  sampleBgs.forEach(bg => {
    const option = document.createElement("option");
    option.value = bg;
    option.textContent = bg;
    bgSelect.appendChild(option);
  });

  // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®å€¤ã‚’é¸æŠè‚¢ã«è¨­å®š
  const s = scenes[currentScene];
  if (s) {
    speakerSelect.value = s.speaker || "";
    faceSelect.value = s.face || "";
    bgSelect.value = s.background || "";
  }
}

// é€²è¡ŒçŠ¶æ³ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿
function saveProgress() {
  localStorage.setItem('yh_progress', currentScene);
  alert('é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
}

function loadProgress() {
  const sv = localStorage.getItem('yh_progress');
  if (sv !== null && !isNaN(+sv) && +sv >= 0 && +sv < scenes.length) {
    currentScene = +sv;
    showScene(currentScene);
    alert('ä¿å­˜åœ°ç‚¹ã‹ã‚‰å†é–‹ã—ã¾ã—ãŸã€‚');
  } else {
    alert('æœ‰åŠ¹ãªä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
  }
}

// éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½
function toggleVoice() {
  useVoice = !useVoice;
  document.getElementById("voice-status").textContent = useVoice ? "ã‚ªãƒ³" : "ã‚ªãƒ•";
  alert('èª­ã¿ä¸Šã’ï¼š' + (useVoice ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•'));
}

function speak(txt) {
  if ('speechSynthesis' in window) {
    const msg = new SpeechSynthesisUtterance(txt);
    msg.lang = 'ja-JP';
    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
  } else {
    console.warn("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
  }
}

// ãƒ­ã‚°ï¼ˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ã®å±•é–‹ã¨æ ¼ç´
function expandLog() {
  document.getElementById('dialogue-box').classList.add('expanded');
}

function collapseLog() {
  document.getElementById('dialogue-box').classList.remove('expanded');
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã®é–‹é–‰
function openModal() {
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

// scenes.jsonã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
function downloadScenes() {
  if (scenes.length === 0) {
    alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  const blob = new Blob([JSON.stringify(scenes, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "scenes.json";
  document.body.appendChild(a); // Firefoxå¯¾å¿œ
  a.click();
  document.body.removeChild(a); // Firefoxå¯¾å¿œ
  URL.revokeObjectURL(a.href); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’è§£æ”¾
}

// scenes.jsonã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadScenes() {
  document.getElementById('file-input').click();
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) {
    return;
  }
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const uploadedData = JSON.parse(e.target.result);
      if (!Array.isArray(uploadedData)) {
        throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸJSONã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
      }

      // æ—¢å­˜ã®microCMSãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ (æ³¨æ„: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™)
      // ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•: IDã‚’åŸºã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°/è¿½åŠ /å‰Šé™¤ã‚’å€‹åˆ¥ã«è¡Œã†ãƒ­ã‚¸ãƒƒã‚¯
      const existingSceneIds = new Set(scenes.map(s => s.id));
      const uploadedSceneIds = new Set(uploadedData.map(s => s.id).filter(Boolean));

      // microCMSã«å­˜åœ¨ã—ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã«ãªã„ã‚‚ã®ã‚’å‰Šé™¤
      for (const scene of scenes) {
          if (!uploadedSceneIds.has(scene.id)) {
              await deleteSceneFromMicroCMS(scene.id);
          }
      }

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’microCMSã«åæ˜  (æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ)
      for (const scene of uploadedData) {
          const method = existingSceneIds.has(scene.id) ? 'PATCH' : 'POST';
          const url = scene.id && existingSceneIds.has(scene.id) ? `${apiBase}/${scene.id}` : apiBase;
          
          // microCMSã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
          const dataToSend = {
              speaker: scene.speaker,
              text: scene.text,
              face: scene.face,
              background: scene.background,
              special: scene.special,
              episode: scene.episode || 1,
              sceneNumber: scene.sceneNumber || 1
          };

          const res = await fetch(url, {
              method: method,
              headers: {
                  'Content-Type': 'application/json',
                  'X-API-KEY': apiKey
              },
              body: JSON.stringify(dataToSend)
          });
          if (!res.ok) {
              const errorData = await res.json();
              throw new Error(`API error during upload (${method} ${url})! status: ${res.status}, message: ${JSON.stringify(errorData)}`);
          }
      }
      
      alert("ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€microCMSã«åŒæœŸã•ã‚Œã¾ã—ãŸï¼");
      closeModal();
      loadScenes(); // åŒæœŸå¾Œã€æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†ãƒ­ãƒ¼ãƒ‰
    } catch (error) {
      console.error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
      alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONå½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  };
  reader.readAsText(file);
}

// ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤æ©Ÿèƒ½
async function deleteScene() {
  if (scenes.length === 0) {
    alert("å‰Šé™¤ã™ã‚‹ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  if (!confirm("æœ¬å½“ã«ã“ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    return;
  }

  const s = scenes[currentScene];
  if (!s || !s.id) {
    alert("ã“ã®ã‚·ãƒ¼ãƒ³ã¯ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ãªã„ã‹ã€IDãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  try {
    await deleteSceneFromMicroCMS(s.id);
    alert("ã‚·ãƒ¼ãƒ³ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚");
    scenes.splice(currentScene, 1); // ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã‹ã‚‰å‰Šé™¤
    if (currentScene >= scenes.length) { // æœ€å¾Œã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ãŸå ´åˆ
      currentScene = Math.max(0, scenes.length - 1);
    }
    showScene(currentScene);
    populateSelectOptions();
    collapseLog();
  } catch (error) {
    console.error("ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    alert("ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

async function deleteSceneFromMicroCMS(sceneId) {
    const res = await fetch(`${apiBase}/${sceneId}`, {
        method: 'DELETE',
        headers: { 'X-API-KEY': apiKey }
    });
    if (!res.ok) {
        const errorData = await res.json();
        throw new Error(`API error during delete! status: ${res.status}, message: ${JSON.stringify(errorData)}`);
    }
}


// æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã®è¿½åŠ æ©Ÿèƒ½
async function addScene() {
  const newScene = {
    speaker: "æ–°ã—ã„è©±è€…",
    text: "æ–°ã—ã„ã‚»ãƒªãƒ•",
    face: "",
    background: "default_bg",
    special: "",
    episode: scenes[currentScene]?.episode || 1, // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®EPã‚’ç¶™æ‰¿
    sceneNumber: (scenes[currentScene]?.sceneNumber || 0) + 1 // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®æ¬¡
  };

  // microCMSã«POSTã—ã¦æ–°è¦ã‚·ãƒ¼ãƒ³ã‚’ä½œæˆ
  try {
    const res = await fetch(apiBase, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-KEY': apiKey
      },
      body: JSON.stringify(newScene)
    });

    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(`API error! status: ${res.status}, message: ${JSON.stringify(errorData)}`);
    }
    const createdScene = await res.json();
    newScene.id = createdScene.id; // microCMSã‹ã‚‰è¿”ã•ã‚ŒãŸIDã‚’è¨­å®š

    scenes.splice(currentScene + 1, 0, newScene); // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®æ¬¡ã«æŒ¿å…¥
    currentScene++; // æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã«ç§»å‹•
    showScene(currentScene);
    populateSelectOptions();
    expandLog(); // è¿½åŠ å¾Œã€ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
    alert("æ–°ã—ã„ã‚·ãƒ¼ãƒ³ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼");
  } catch (error) {
    console.error("æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    alert("æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}


// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
const box = document.getElementById('dialogue-box');
let startY = 0, startX = 0, touchStartTime = 0;

box.addEventListener('touchstart', e => {
  startY = e.touches[0].clientY;
  startX = e.touches[0].clientX;
  touchStartTime = Date.now();
});

box.addEventListener('touchend', e => {
  const endY = e.changedTouches[0].clientY;
  const endX = e.changedTouches[0].clientX;
  const dy = startY - endY;
  const dx = startX - endX;
  const dt = Date.now() - touchStartTime;

  const dialogueBox = document.getElementById('dialogue-box');
  const isExpanded = dialogueBox.classList.contains('expanded');

  // ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒ­ã‚°å±•é–‹
  if (dy > 50 && Math.abs(dx) < 50 && dt < 300 && !isExpanded) { // é–¾å€¤ã‚’å°‘ã—å³ã—ã
    expandLog();
    return;
  }
  // ä¸‹ã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒ­ã‚°æ ¼ç´
  if (endY - startY > 50 && Math.abs(dx) < 50 && dt < 300 && isExpanded) { // é–¾å€¤ã‚’å°‘ã—å³ã—ã
    collapseLog();
    return;
  }
  // é•·æŠ¼ã—ï¼ˆã‚¿ãƒƒãƒ—ï¼†ãƒ›ãƒ¼ãƒ«ãƒ‰ï¼‰ã§ãƒ­ã‚°å±•é–‹/æ ¼ç´
  if (Math.abs(dy) < 10 && Math.abs(dx) < 10 && dt >= 500) { // çŸ­ã„ã‚¿ãƒƒãƒ—ã¨åŒºåˆ¥
    if (isExpanded) {
      collapseLog();
    } else {
      expandLog();
    }
    return;
  }
});

// bodyã‚¯ãƒªãƒƒã‚¯ã§ã‚·ãƒ¼ãƒ³é·ç§»
document.body.addEventListener('click', e => {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€ã¾ãŸã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒå±•é–‹ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
  if (document.getElementById("modal").style.display === "flex" || box.classList.contains('expanded')) {
    return;
  }

  // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ å†…ã®è¦ç´ ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
  if (e.target.closest('#edit-form') || e.target.closest('#controls') || e.target.closest('#header')) {
    return;
  }

  const x = e.clientX;
  const w = window.innerWidth;
  
  if (x < w / 3) { // ç”»é¢å·¦1/3ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å‰ã¸
    currentScene--;
  } else if (x > w * 2 / 3) { // ç”»é¢å³1/3ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã¸
    currentScene++;
  } else { // ç”»é¢ä¸­å¤®1/3ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒ­ã‚°å±•é–‹
    expandLog();
    return; // ã‚·ãƒ¼ãƒ³é·ç§»ã¯ã—ãªã„
  }

  currentScene = Math.max(0, Math.min(currentScene, scenes.length - 1));
  showScene(currentScene);
});

// åˆæœŸãƒ­ãƒ¼ãƒ‰
loadScenes();
</script>
</body>
</html>
