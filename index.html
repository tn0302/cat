<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>å‹‡è€…ãƒãƒ¼ãƒ¬ãƒ  - ãƒãƒ™ãƒ«ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        #header { height: 48px; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: space-between; padding: 0 12px; }
        #novel-container { position: relative; height: calc(100% - 48px); }
        #background, #special-image { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 0; }
        #special-image { object-fit: contain; background: none; } /* ä¸€æšçµµã®å ´åˆ */
        #character { position: absolute; bottom: -10%; left: 50%; transform: translateX(-50%); max-height: 70%; max-width: 100%; object-fit: contain; z-index: 1; transition: filter 0.3s ease; }
        #character.dimmed { filter: brightness(0.5); }
        #dialogue-box { position: absolute; bottom: 0; width: 100%; min-height: 120px; background: rgba(0,0,0,0.8); padding: 12px; box-sizing: border-box; z-index: 2; }
        #dialogue-text { font-size: 1.2em; line-height: 1.5; margin-bottom: 8px; }
        #speaker-name { font-weight: bold; color: #f80; margin-bottom: 4px; }
        #name-box { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 8px 12px; border-radius: 4px; font-weight: bold; color: #f80; z-index: 3; }
        #controls { position: absolute; top: 0; right: 0; padding: 8px; z-index: 10; display: flex; gap: 8px; }
        #controls button, .modal button { padding: 8px 12px; background: #333; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        #controls button:hover, .modal button:hover { background: #555; }
        #modal, #asset-upload-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: #222; padding: 20px; border-radius: 8px; text-align: center; max-width: 90%; max-height: 90%; overflow-y: auto; }
        .modal-content label, .modal-content input, .modal-content textarea, .modal-content select { display: block; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .modal-content input[type="text"], .modal-content textarea, .modal-content select { padding: 8px; border: 1px solid #555; background: #333; color: #fff; border-radius: 4px; }
        .modal-content button { margin-top: 10px; }
        #edit-form-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 99; }
        #edit-form { background: #222; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow-y: auto; text-align: left; }
        #edit-form label { display: block; margin-bottom: 10px; color: #eee; }
        #edit-form input[type="text"], #edit-form textarea, #edit-form select { width: calc(100% - 16px); padding: 8px; border: 1px solid #555; background: #333; color: #fff; border-radius: 4px; }
        #edit-form button { padding: 8px 12px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        #edit-form button:hover { background: #0056b3; }
        #scene-list-container { max-height: 300px; overflow-y: auto; border: 1px solid #555; margin-top: 10px; }
        .scene-item { padding: 8px; border-bottom: 1px solid #444; cursor: pointer; text-align: left; }
        .scene-item.current-scene { background-color: #007bff; }
        #log-area {
            position: absolute;
            top: 48px;
            left: 0;
            width: 100%;
            height: calc(100% - 48px);
            background: rgba(0,0,0,0.9);
            color: #fff;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            transform: translateY(100%); /* Initially hidden below */
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        #log-area.expanded {
            transform: translateY(0); /* Expanded to show */
        }
        .log-entry { margin-bottom: 10px; }
        .log-entry strong { color: #f80; } /* Speaker name in log */
    </style>
</head>
<body>
    <div id="header">
        <span id="episode-info">ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ 1 - ã‚·ãƒ¼ãƒ³ 1</span>
        <div>
            <button onclick="toggleEditForm()">ç·¨é›†</button>
            <button onclick="showAssetUploadModal()">ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <button onclick="toggleLog()">ãƒ­ã‚°</button>
        </div>
    </div>
    <div id="novel-container">
        <div id="background"></div>
        <img id="special-image" src="" alt="" style="display: none;" />
        <img id="character" src="" alt="" style="display: none;" />

        <div id="dialogue-box">
            <div id="speaker-name"></div>
            <div id="dialogue-text"></div>
        </div>
        <div id="name-box" style="display: none;"></div>
    </div>

    <div id="edit-form-container">
        <div id="edit-form">
            <label>ã‚·ãƒ¼ãƒ³IDï¼š<input type="text" id="edit-scene-id" readonly /></label>
            <label>ãƒãƒ£ãƒ—ã‚¿ãƒ¼ï¼š<input type="number" id="edit-chapter" min="1" /></label>
            <label>ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼š<input type="number" id="edit-episode" min="1" /></label>
            <label>ã‚·ãƒ¼ãƒ³ç•ªå·ï¼š<input type="number" id="edit-scene" min="1" /></label>
            <label>è©±è€…ï¼š<select id="edit-speaker"></select></label>
            <label>ã‚»ãƒªãƒ•ï¼š<textarea id="edit-text" rows="3"></textarea></label>
            <label>è¡¨æƒ…ï¼š<select id="edit-face"></select></label>
            <label>èƒŒæ™¯ï¼š<select id="edit-bg"></select></label>
            <label>ç‰¹æ®Šï¼š<input type="text" id="edit-special" placeholder="ç‰¹æ®ŠåŠ¹æœã‚„ã‚¢ã‚»ãƒƒãƒˆã‚¿ã‚°" /></label>
            <button onclick="applyEdits()">âœ… é©ç”¨</button>
            <button onclick="deleteScene()" style="background: #a00; margin-left: 8px;">ğŸ—‘ï¸ ã“ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤</button>
            <button onclick="addScene()" style="background: #0a0; margin-left: 8px;">â• ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ </button>
            <button onclick="cancelEdit()" style="background: #555; margin-left: 8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <hr style="margin-top: 20px; border-color: #555;" />
            <h3>ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆ</h3>
            <div id="scene-list-container">
                </div>
        </div>
    </div>

    <div id="asset-upload-modal">
        <div class="modal-content">
            <h2>ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <label>ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼š<input type="file" id="asset-file" accept="image/*" /></label>
            <label>ã‚¢ã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒ—ï¼š
                <select id="asset-type-select">
                    <option value="character">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</option>
                    <option value="background">èƒŒæ™¯</option>
                    <option value="special_image">ä¸€æšçµµ</option>
                    <option value="character_face">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨æƒ…ã‚¢ã‚»ãƒƒãƒˆ</option>
                    </select>
            </label>
            <label>ã‚¿ã‚°ï¼ˆå¿…é ˆï¼‰ï¼š<input type="text" id="asset-tag" placeholder="ä¾‹: ãƒãƒãƒ«, æ£®" /></label>
            <label id="character-face-tag-label" style="display: none;">è¡¨æƒ…ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰ï¼š<input type="text" id="character-face-tag" placeholder="ä¾‹: ç¬‘é¡”, å†·ç¬‘" /></label>
            <label id="character-special-label" style="display: none;">ç‰¹æ®Šï¼ˆä»»æ„ï¼‰ï¼š<input type="text" id="character-special" placeholder="ä¾‹: winter, ver2" /></label>
            <button onclick="handleAssetUpload()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <button onclick="hideAssetUploadModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button id="modal-confirm-btn">ã¯ã„</button>
            <button id="modal-cancel-btn">ã„ã„ãˆ</button>
        </div>
    </div>

    <div id="log-area">
        <h3 style="text-align: center;">ãƒ­ã‚°</h3>
        <div id="log-content"></div>
    </div>

    <script>
        // ç’°å¢ƒå¤‰æ•°ã¨ãƒ‘ã‚¹å®šç¾©
        const ASSETS_PROXY_PATH = '/api/assets'; // assets.mjs ã‚’å©ããƒ‘ã‚¹
        const SCENES_PROXY_PATH = '/api/scenes'; // scenes.mjs ã‚’å©ããƒ‘ã‚¹
        const SPECIFIC_SCENE_PROXY_PATH = '/api/scenes/'; // api/scenes/[id].mjs ã‚’å©ããƒ‘ã‚¹

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentEpisode = 1;
        let currentSceneIndex = 0;
        let episodeData = [];
        let currentEditingScene = null; // ç¾åœ¨ç·¨é›†ä¸­ã®ã‚·ãƒ¼ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let touchStartTime = 0; // ã‚¹ãƒ¯ã‚¤ãƒ—æ¤œå‡ºç”¨

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ã®å¤‰æ•°
        let speakersDataCache = [];
        let facesDataCache = [];
        let backgroundsDataCache = [];

        // --- APIå‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        // MicroCMSã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§å…¨ã¦å–å¾—ã™ã‚‹æ±ç”¨é–¢æ•°
        // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç›´æ¥ MicroCMS API ã‚’å©ãã‚ã‘ã§ã¯ãªãã€Vercel ã® /api ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ãæƒ³å®š
        async function fetchAllDataWithPagination(apiEndpoint, filters = [], limit = 100, offset = 0, specificMicroCMSEndpoint = null) {
            let allData = [];
            let currentOffset = offset;
            let hasMore = true;

            const url = new URL(window.location.origin + apiEndpoint); // Vercelã®APIãƒ«ãƒ¼ãƒˆã®URLã‚’æ§‹ç¯‰
            if (specificMicroCMSEndpoint) {
                // MicroCMSå´ã®ç‰¹å®šã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã™ã‚‹å ´åˆ (ä¾‹: /api/scenes?endpoint=speakers)
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã“ã® 'endpoint' ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£é‡ˆã—ã¦MicroCMSã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                url.searchParams.append('microcms_endpoint', specificMicroCMSEndpoint);
            }
            url.searchParams.append('limit', limit);
            url.searchParams.append('offset', currentOffset);
            
            // filtersã‚’é…åˆ—ã¨ã—ã¦æ‰±ã„ã€å„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å€‹åˆ¥ã®'filters'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ 
            filters.forEach(filter => {
                if (filter) { // nullã‚„ç©ºæ–‡å­—åˆ—ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é™¤å¤–
                    url.searchParams.append('filters', filter);
                }
            });

            console.log(`[FE] Fetching data from: ${url.toString()}`);

            try {
                const response = await fetch(url.toString());
                const data = await response.json();

                if (!response.ok) {
                    const errorMessage = data.error || response.statusText;
                    const details = data.details ? `Details: ${JSON.stringify(data.details)}` : '';
                    throw new Error(`API Error (${apiEndpoint}): ${response.status} - ${errorMessage} ${details}`);
                }

                allData = allData.concat(data.contents || data); // data.contentsãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã„å ´åˆã¯dataè‡ªä½“ã‚’ä½¿ç”¨

                // totalCount ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã‚’ä½¿ã£ã¦hasMoreã‚’åˆ¤å®š
                if (data.totalCount !== undefined) {
                    hasMore = (currentOffset + limit) < data.totalCount;
                } else {
                    // totalCount ãŒãªã„å ´åˆã€å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®é‡ã§åˆ¤å®š
                    hasMore = data.contents && data.contents.length === limit;
                }
                
                currentOffset += limit;
            } catch (error) {
                console.error(`[FE] Error fetching data from API route ${apiEndpoint}:`, error);
                throw error;
            }
            
            return allData;
        }

        // --- ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ‰ ---
        async function loadDropdownOptions() {
            try {
                // MicroCMSã®ã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é¸æŠè‚¢ã¯ã€é€šå¸¸APIçµŒç”±ã§ã¯ç›´æ¥å–å¾—ã§ãã¾ã›ã‚“ã€‚
                // ãã®ãŸã‚ã€ã“ã“ã§ã¯ MicroCMSã®assetsã‹ã‚‰ã€å¯¾å¿œã™ã‚‹ã‚¿ã‚°ã‚’æŒã¤ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã€
                // è©±è€…ã€è¡¨æƒ…ã€èƒŒæ™¯ã®é¸æŠè‚¢ã‚’æ“¬ä¼¼çš„ã«å–å¾—ã—ã¾ã™ã€‚

                // è©±è€…ãƒªã‚¹ãƒˆã®å–å¾—: asset_type=characterã®ã‚¢ã‚»ãƒƒãƒˆã®tagã‚’é›†ã‚ã‚‹
                const characterAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, ['asset_type[equals]character']);
                speakersDataCache = Array.from(new Set(characterAssets.map(a => a.tag).filter(Boolean)));
                
                // è¡¨æƒ…ãƒªã‚¹ãƒˆã®å–å¾—: character_face_tagã‚’æŒã¤ã‚¢ã‚»ãƒƒãƒˆã®character_face_tagã‚’é›†ã‚ã‚‹
                // ï¼ˆcharacter_face_tagã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã®ã§ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå€¤ã‚’åé›†ï¼‰
                const faceAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, ['character_face_tag[exists]']);
                facesDataCache = Array.from(new Set(faceAssets.map(a => a.character_face_tag).filter(Boolean)));

                // èƒŒæ™¯ãƒªã‚¹ãƒˆã®å–å¾—: asset_type=backgroundã®ã‚¢ã‚»ãƒƒãƒˆã®tagã‚’é›†ã‚ã‚‹
                const backgroundAssets = await fetchAllDataWithPagination(ASSETS_PROXY_PATH, ['asset_type[equals]background']);
                backgroundsDataCache = Array.from(new Set(backgroundAssets.map(a => a.tag).filter(Boolean)));
                
                console.log('Dropdown options loaded:', { speakers: speakersDataCache, faces: facesDataCache, backgrounds: backgroundsDataCache });

            } catch (error) {
                console.error('Failed to load dropdown options:', error);
                alert('é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }


        // --- ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿é–¢é€£é–¢æ•° ---

        async function loadEpisodeData() {
            try {
                // ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
                const filters = [`episode[equals]${currentEpisode}`];
                console.log(`[FE] Loading scenes data for episode: ${currentEpisode}`);
                const data = await fetchAllDataWithPagination(SCENES_PROXY_PATH + `?episode=${currentEpisode}`);
                
                episodeData = data.sort((a, b) => a.sceneNumber - b.sceneNumber);
                if (episodeData.length === 0) {
                    // ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒ¼ãƒ³ã‚’ä½œæˆ
                    episodeData = [{
                        id: 'new-scene-001', // ä»®ã®ID
                        chapterNumber: currentEpisode,
                        episode: currentEpisode,
                        sceneNumber: 1,
                        speaker: '',
                        text: 'æ–°ã—ã„ç‰©èªãŒå§‹ã¾ã‚Šã¾ã™ã€‚',
                        face: '',
                        background: '',
                        special: ''
                    }];
                    console.warn(`[FE] No data found for episode ${currentEpisode}. Created a default scene.`);
                }
                
                displayScene(currentSceneIndex);
                updateSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚‚æ›´æ–°

            } catch (error) {
                console.error(`[FE] ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ ${currentEpisode} ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
                alert(`ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ ${currentEpisode} ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
        }

        function displayScene(index) {
            if (index < 0 || index >= episodeData.length) {
                console.warn(`[FE] Scene index ${index} out of bounds.`);
                return;
            }

            currentSceneIndex = index;
            const scene = episodeData[currentSceneIndex];

            document.getElementById('episode-info').textContent = `ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ ${scene.episode} - ã‚·ãƒ¼ãƒ³ ${scene.sceneNumber}`;
            document.getElementById('speaker-name').textContent = scene.speaker || '';
            document.getElementById('dialogue-text').textContent = scene.text || '';
            
            // åå‰ã®è¡¨ç¤ºåˆ¶å¾¡
            const nameBox = document.getElementById('name-box');
            if (scene.speaker && scene.speaker !== 'ãƒ¢ãƒãƒ­ãƒ¼ã‚°') { // ãƒ¢ãƒãƒ­ãƒ¼ã‚°ã§ãªã„å ´åˆã®ã¿è¡¨ç¤º
                nameBox.textContent = scene.speaker;
                nameBox.style.display = 'block';
            } else {
                nameBox.style.display = 'none';
            }

            // èƒŒæ™¯ç”»åƒã®è¡¨ç¤º
            const backgroundElement = document.getElementById('background');
            if (scene.background) {
                // scene.background ãŒæ—¢ã«URLã®å ´åˆã¨ã€ã‚¿ã‚°åã®å ´åˆã«å¯¾å¿œ
                backgroundElement.style.backgroundImage = `url('${scene.background}')`;
            } else {
                backgroundElement.style.backgroundImage = 'none';
            }

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®è¡¨ç¤º
            const characterElement = document.getElementById('character');
            if (scene.speaker && scene.speaker !== 'ãƒ¢ãƒãƒ­ãƒ¼ã‚°') {
                // `asset_type`ãŒã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã®ã§`equals`ã‚’ä½¿ç”¨
                let charFilter = `asset_type[equals]character[and]tag[equals]${scene.speaker}`;
                if (scene.face) { // è¡¨æƒ…ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
                    charFilter += `[and]character_face_tag[equals]${scene.face}`;
                }
                if (scene.special) { // ç‰¹æ®Šã‚¿ã‚°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
                    charFilter += `[and]character_special[equals]${scene.special}`;
                }

                // assetsã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚»ãƒƒãƒˆã‚’æ¤œç´¢
                fetchAllDataWithPagination(ASSETS_PROXY_PATH, [charFilter])
                    .then(charAssets => {
                        if (charAssets && charAssets.length > 0) {
                            characterElement.src = charAssets[0].image.url;
                            characterElement.style.display = 'block';
                            // é–¢é€£ã™ã‚‹ãƒ­ã‚°ã‚¢ã‚¤ãƒ†ãƒ ã®èƒŒæ™¯è‰²ã‚’æ›´æ–°
                            updateLogEntryHighlight(scene.sceneNumber, true);
                        } else {
                            console.warn(`[FE] Character asset not found for speaker: ${scene.speaker}, face: ${scene.face}, special: ${scene.special}`);
                            characterElement.style.display = 'none';
                            updateLogEntryHighlight(scene.sceneNumber, false);
                        }
                    })
                    .catch(error => {
                        console.error(`[FE] Error fetching character asset for ${scene.speaker}:`, error);
                        characterElement.style.display = 'none';
                        updateLogEntryHighlight(scene.sceneNumber, false);
                    });
            } else {
                characterElement.style.display = 'none';
                updateLogEntryHighlight(scene.sceneNumber, true); // ã‚»ãƒªãƒ•ã®ã¿ã®ã‚·ãƒ¼ãƒ³ã‚‚ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            }

            // ç‰¹æ®Šç”»åƒï¼ˆä¸€æšçµµãªã©ï¼‰ã®è¡¨ç¤º
            const specialImageElement = document.getElementById('special-image');
            if (scene.special && scene.speaker === 'ãƒ¢ãƒãƒ­ãƒ¼ã‚°') { // ãƒ¢ãƒãƒ­ãƒ¼ã‚°ã§ç‰¹æ®ŠãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã‚’ä¸€æšçµµã¨ä»®å®š
                 // `asset_type`ãŒã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã®ã§`equals`ã‚’ä½¿ç”¨
                fetchAllDataWithPagination(ASSETS_PROXY_PATH, [`asset_type[equals]special_image[and]tag[equals]${scene.special}`])
                    .then(specialAssets => {
                        if (specialAssets && specialAssets.length > 0) {
                            specialImageElement.src = specialAssets[0].image.url;
                            specialImageElement.style.display = 'block';
                        } else {
                            console.warn(`[FE] Special image asset not found for tag: ${scene.special}`);
                            specialImageElement.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error(`[FE] Error fetching special image asset for ${scene.special}:`, error);
                        specialImageElement.style.display = 'none';
                    });
            } else {
                specialImageElement.style.display = 'none';
            }
            updateLog(); // ãƒ­ã‚°ã‚’æ›´æ–°
            updateSceneListHighlight(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°
        }

        function goToNextScene() {
            if (currentSceneIndex < episodeData.length - 1) {
                displayScene(currentSceneIndex + 1);
            } else {
                alert('ã“ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã¯çµ‚ã‚ã‚Šã§ã™ï¼');
            }
        }

        function goToPreviousScene() {
            if (currentSceneIndex > 0) {
                displayScene(currentSceneIndex - 1);
            } else {
                alert('ã“ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®æœ€åˆã®ã‚·ãƒ¼ãƒ³ã§ã™ã€‚');
            }
        }

        // --- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ é–¢é€£é–¢æ•° ---

        function toggleEditForm() {
            const formContainer = document.getElementById('edit-form-container');
            if (formContainer.style.display === 'flex') {
                formContainer.style.display = 'none';
            } else {
                updateEditForm(episodeData[currentSceneIndex]);
                formContainer.style.display = 'flex';
            }
        }

        function cancelEdit() {
            document.getElementById('edit-form-container').style.display = 'none';
        }


        // --- ä¿®æ­£ç®‡æ‰€ ---
        function updateEditForm(scene) {
            currentEditingScene = scene; // ç¾åœ¨ç·¨é›†ä¸­ã®ã‚·ãƒ¼ãƒ³ã‚’è¨­å®š

            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¦ç´ ã®å–å¾—
            const speakerSelect = document.getElementById('edit-speaker');
            const faceSelect = document.getElementById('edit-face');
            const bgSelect = document.getElementById('edit-bg');

            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            speakerSelect.innerHTML = '';
            faceSelect.innerHTML = '';
            bgSelect.innerHTML = '';

            // å„ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            // è©±è€…
            speakersDataCache.forEach(speaker => {
                const option = document.createElement('option');
                option.value = speaker;
                option.textContent = speaker;
                speakerSelect.appendChild(option);
            });
            // ç©ºã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆæœªé¸æŠçŠ¶æ…‹ã‚’è¨±å®¹ã™ã‚‹å ´åˆï¼‰
            const speakerDefaultOption = document.createElement('option');
            speakerDefaultOption.value = '';
            speakerDefaultOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
            speakerSelect.prepend(speakerDefaultOption);


            // è¡¨æƒ…
            facesDataCache.forEach(face => {
                const option = document.createElement('option');
                option.value = face;
                option.textContent = face;
                faceSelect.appendChild(option);
            });
            // ç©ºã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const faceDefaultOption = document.createElement('option');
            faceDefaultOption.value = '';
            faceDefaultOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
            faceSelect.prepend(faceDefaultOption);

            // èƒŒæ™¯
            backgroundsDataCache.forEach(bg => {
                const option = document.createElement('option');
                option.value = bg;
                option.textContent = bg;
                bgSelect.appendChild(option);
            });
            // ç©ºã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const bgDefaultOption = document.createElement('option');
            bgDefaultOption.value = '';
            bgDefaultOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
            bgSelect.prepend(bgDefaultOption);


            // ã‚·ãƒ¼ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
            document.getElementById('edit-scene-id').value = scene.id || '';
            document.getElementById('edit-chapter').value = scene.chapterNumber || '';
            document.getElementById('edit-episode').value = scene.episode || '';
            document.getElementById('edit-scene').value = scene.sceneNumber || '';
            document.getElementById('edit-speaker').value = scene.speaker || ''; // scene.speakerãŒnull/undefinedã®å ´åˆã«ç©ºæ–‡å­—åˆ—
            document.getElementById('edit-text').value = scene.text || '';
            document.getElementById('edit-face').value = scene.face || '';
            document.getElementById('edit-bg').value = scene.background || '';
            document.getElementById('edit-special').value = scene.special || '';

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            document.getElementById('edit-form-container').style.display = 'flex';
        }
        // --- ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ ---


        async function applyEdits() {
            const sceneId = document.getElementById('edit-scene-id').value;
            const updatedData = {
                chapterNumber: parseInt(document.getElementById('edit-chapter').value),
                episode: parseInt(document.getElementById('edit-episode').value),
                sceneNumber: parseInt(document.getElementById('edit-scene').value),
                speaker: document.getElementById('edit-speaker').value,
                text: document.getElementById('edit-text').value,
                face: document.getElementById('edit-face').value,
                background: document.getElementById('edit-bg').value,
                special: document.getElementById('edit-special').value,
            };

            try {
                const response = await fetch(SPECIFIC_SCENE_PROXY_PATH + sceneId, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedData),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update scene.');
                }

                console.log('[FE] Scene updated successfully:', data);
                alert('ã‚·ãƒ¼ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼');
                document.getElementById('edit-form-container').style.display = 'none';
                await loadEpisodeData(); // æ›´æ–°å¾Œã€ãƒ‡ãƒ¼ã‚¿ã‚’å†ãƒ­ãƒ¼ãƒ‰ã—ã¦UIã‚’æœ€æ–°ã«ã™ã‚‹

            } catch (error) {
                console.error('[FE] Error applying edits:', error);
                alert('ã‚·ãƒ¼ãƒ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteScene() {
            const sceneId = document.getElementById('edit-scene-id').value;
            if (!sceneId || sceneId.startsWith('new-scene-')) {
                alert('æ–°è¦ä½œæˆã•ã‚ŒãŸæœªä¿å­˜ã®ã‚·ãƒ¼ãƒ³ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
                return;
            }

            const confirmDelete = await showConfirmModal('ã“ã®ã‚·ãƒ¼ãƒ³ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
            if (!confirmDelete) return;

            try {
                const response = await fetch(SPECIFIC_SCENE_PROXY_PATH + sceneId, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to delete scene.');
                }

                console.log('[FE] Scene deleted successfully.');
                alert('ã‚·ãƒ¼ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼');
                document.getElementById('edit-form-container').style.display = 'none';
                await loadEpisodeData(); // å‰Šé™¤å¾Œã€ãƒ‡ãƒ¼ã‚¿ã‚’å†ãƒ­ãƒ¼ãƒ‰ã—ã¦UIã‚’æœ€æ–°ã«ã™ã‚‹

            } catch (error) {
                console.error('[FE] Error deleting scene:', error);
                alert('ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function addScene() {
            const newSceneNumber = episodeData.length > 0 ? Math.max(...episodeData.map(s => s.sceneNumber)) + 1 : 1;
            const newScene = {
                id: `new-scene-${Date.now()}`, // ä¸€æ™‚çš„ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ID
                chapterNumber: currentEpisode,
                episode: currentEpisode,
                sceneNumber: newSceneNumber,
                speaker: '',
                text: 'æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã®ã‚»ãƒªãƒ•',
                face: '',
                background: '',
                special: ''
            };

            // æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã‚’æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
            episodeData.push(newScene);
            // ã‚·ãƒ¼ãƒ³ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
            episodeData.sort((a, b) => a.sceneNumber - b.sceneNumber);

            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ–°ã—ã„ã‚·ãƒ¼ãƒ³ã§é–‹ã
            updateEditForm(newScene);
            updateSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            alert('æ–°ã—ã„ã‚·ãƒ¼ãƒ³ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ç·¨é›†å¾Œã€Œé©ç”¨ã€ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
        }

        function updateSceneList() {
            const sceneListContainer = document.getElementById('scene-list-container');
            sceneListContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢

            episodeData.forEach((scene, index) => {
                const sceneItem = document.createElement('div');
                sceneItem.className = 'scene-item';
                sceneItem.textContent = `ã‚·ãƒ¼ãƒ³ ${scene.sceneNumber}: ${scene.speaker || ''}ã€Œ${scene.text.substring(0, 20)}...ã€`;
                sceneItem.dataset.index = index;
                sceneItem.onclick = () => {
                    displayScene(index); // ã‚·ãƒ¼ãƒ³è¡¨ç¤º
                    updateEditForm(scene); // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚‚ãã®ã‚·ãƒ¼ãƒ³ã§é–‹ã
                };
                sceneListContainer.appendChild(sceneItem);
            });
            updateSceneListHighlight(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚æ›´æ–°
        }

        function updateSceneListHighlight() {
            const sceneItems = document.querySelectorAll('.scene-item');
            sceneItems.forEach(item => {
                if (parseInt(item.dataset.index) === currentSceneIndex) {
                    item.classList.add('current-scene');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    item.classList.remove('current-scene');
                }
            });
        }


        // --- ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£é–¢æ•° ---

        function showAssetUploadModal() {
            document.getElementById('asset-upload-modal').style.display = 'flex';
            // asset_typeãŒcharacter_faceã®å ´åˆã«è¡¨æƒ…ã‚¿ã‚°ã¨ç‰¹æ®Šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
            document.getElementById('asset-type-select').addEventListener('change', function() {
                const isCharacterFace = this.value === 'character_face';
                document.getElementById('character-face-tag-label').style.display = isCharacterFace ? 'block' : 'none';
                document.getElementById('character-special-label').style.display = isCharacterFace ? 'block' : 'none';
            });
        }

        function hideAssetUploadModal() {
            document.getElementById('asset-upload-modal').style.display = 'none';
        }

        async function handleAssetUpload() {
            const fileInput = document.getElementById('asset-file');
            const assetType = document.getElementById('asset-type-select').value;
            const assetTag = document.getElementById('asset-tag').value;
            const characterFaceTag = document.getElementById('character-face-tag').value;
            const characterSpecial = document.getElementById('character-special').value;

            if (!fileInput.files.length || !assetTag) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¿ã‚°ã¯å¿…é ˆã§ã™ï¼');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            // asset_type ã¯ã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆMicroCMSã§è¤‡æ•°é¸æŠã§ã¯ãªã„å ´åˆï¼‰ã®ãŸã‚ã€å˜ä¸€ã®å€¤ã¨ã—ã¦é€ã‚‹ã€‚
            // ã‚‚ã— MicroCMS ã§è¤‡æ•°é¸æŠã‚’è¨±å¯ã™ã‚‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã©ã§ã‚ã‚Œã°ã€é…åˆ—ã¨ã—ã¦é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
            formData.append('asset_type', assetType); // ã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã®ã§é…åˆ—ã§ã¯ãªãå˜ä¸€ã®å€¤

            formData.append('tag', assetTag);
            
            // character_face_tag ã¨ character_special ã¯ã€å€¤ãŒã‚ã‚Œã°è¿½åŠ 
            if (characterFaceTag) {
                formData.append('character_face_tag', characterFaceTag);
            }
            if (characterSpecial) {
                formData.append('character_special', characterSpecial);
            }
            
            try {
                const response = await fetch(ASSETS_PROXY_PATH, {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to upload asset.');
                }

                alert('ã‚¢ã‚»ãƒƒãƒˆãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸï¼');
                hideAssetUploadModal();
                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸå¾Œã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒˆã‚’å†ãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’åæ˜ 
                await loadDropdownOptions();

            } catch (error) {
                console.error('[FE] Error uploading asset:', error);
                alert('ã‚¢ã‚»ãƒƒãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }


        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ---

        function showConfirmModal(message) {
            return new Promise((resolve) => {
                document.getElementById('modal-message').textContent = message;
                document.getElementById('modal-confirm-btn').onclick = () => {
                    document.getElementById('modal').style.display = 'none';
                    resolve(true);
                };
                document.getElementById('modal-cancel-btn').onclick = () => {
                    document.getElementById('modal').style.display = 'none';
                    resolve(false);
                };
                document.getElementById('modal').style.display = 'flex';
            });
        }

        // --- ãƒ­ã‚°æ©Ÿèƒ½ ---
        const dialogueBox = document.getElementById('dialogue-box');
        const logArea = document.getElementById('log-area');
        const logContent = document.getElementById('log-content');

        function toggleLog() {
            if (logArea.classList.contains('expanded')) {
                collapseLog();
            } else {
                expandLog();
            }
        }

        function expandLog() {
            logArea.classList.add('expanded');
            document.body.style.overflow = 'hidden'; // èƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢
        }

        function collapseLog() {
            logArea.classList.remove('expanded');
            document.body.style.overflow = ''; // èƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯
        }

        function updateLog() {
            logContent.innerHTML = '';
            episodeData.forEach((scene, index) => {
                const logEntry = document.createElement('p');
                logEntry.className = 'log-entry';
                let speakerHtml = scene.speaker ? `<strong>${scene.speaker}</strong>: ` : '';
                logEntry.innerHTML = `${speakerHtml}${scene.text}`;
                logEntry.dataset.sceneNumber = scene.sceneNumber; // ã‚·ãƒ¼ãƒ³ç•ªå·ã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦è¿½åŠ 
                logEntry.onclick = () => {
                    displayScene(index);
                    collapseLog(); // ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
                };
                logContent.appendChild(logEntry);
            });
            // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒ­ã‚°å†…ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            updateLogEntryHighlight(episodeData[currentSceneIndex].sceneNumber, true);
        }

        function updateLogEntryHighlight(sceneNumber, highlight) {
            const logEntries = document.querySelectorAll('.log-entry');
            logEntries.forEach(entry => {
                if (parseInt(entry.dataset.sceneNumber) === sceneNumber) {
                    entry.style.backgroundColor = highlight ? 'rgba(0, 123, 255, 0.5)' : 'transparent';
                } else {
                    entry.style.backgroundColor = 'transparent';
                }
            });
        }


        // --- ã‚¹ãƒ¯ã‚¤ãƒ—/ã‚¿ãƒƒãƒ—æ¤œå‡º ---
        let startY = 0;
        let startX = 0;

        document.body.addEventListener('touchstart', e => {
            if (document.getElementById("modal").style.display === "flex" ||
                document.getElementById("asset-upload-modal").style.display === "flex" ||
                document.getElementById("edit-form-container").style.display === "flex") {
                return;
            }
            startY = e.changedTouches[0].clientY;
            startX = e.changedTouches[0].clientX;
            touchStartTime = Date.now();
        });

        document.body.addEventListener('touchend', e => {
            if (document.getElementById("modal").style.display === "flex" ||
                document.getElementById("asset-upload-modal").style.display === "flex" ||
                document.getElementById("edit-form-container").style.display === "flex") {
                return;
            }
            const endY = e.changedTouches[0].clientY;
            const endX = e.changedTouches[0].clientX;
            const dy = startY - endY;
            const dx = startX - endX;
            const dt = Date.now() - touchStartTime;

            const isExpanded = dialogueBox.classList.contains('expanded');

            // ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒ­ã‚°å±•é–‹ (50pxä»¥ä¸Šä¸Šã€æ¨ªç§»å‹•ã¯50pxä»¥å†…ã€300msä»¥å†…)
            if (dy > 50 && Math.abs(dx) < 50 && dt < 300 && !isExpanded) {
                expandLog();
                return;
            }
            // ä¸‹ã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒ­ã‚°æŠ˜ã‚ŠãŸãŸã¿ (50pxä»¥ä¸Šä¸‹ã€æ¨ªç§»å‹•ã¯50pxä»¥å†…ã€300msä»¥å†…)
            if (endY - startY > 50 && Math.abs(dx) < 50 && dt < 300 && isExpanded) {
                collapseLog();
                return;
            }
            // é•·æŠ¼ã—ã§ãƒ­ã‚°ãƒˆã‚°ãƒ« (ç§»å‹•é‡ãŒå°‘ãªãã€500msä»¥ä¸Š)
            if (Math.abs(dy) < 10 && Math.abs(dx) < 10 && dt >= 500) {
                if (isExpanded) {
                    collapseLog();
                } else {
                    expandLog();
                }
                return;
            }
        });

        document.body.addEventListener('click', e => {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚„ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã€ãƒ­ã‚°ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†ã—ãªã„
            if (document.getElementById("modal").style.display === "flex" ||
                document.getElementById("asset-upload-modal").style.display === "flex" ||
                document.getElementById("edit-form-container").style.display === "flex" ||
                logArea.classList.contains('expanded')) { // ãƒ­ã‚°å±•é–‹æ™‚ã‚‚ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†ã—ãªã„
                return;
            }

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚„ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
            if (e.target.closest('#edit-form') || e.target.closest('#controls') || e.target.closest('#header')) {
                return;
            }
            
            // ãã‚Œä»¥å¤–ã¯æ¬¡ã®ã‚·ãƒ¼ãƒ³ã¸
            goToNextScene();
        });


        // --- åˆæœŸãƒ­ãƒ¼ãƒ‰ ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å…ˆã«ãƒ­ãƒ¼ãƒ‰
            await loadDropdownOptions(); 
            // ãã®å¾Œã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€æœ€åˆã®ã‚·ãƒ¼ãƒ³ã‚’è¡¨ç¤º
            await loadEpisodeData();
        });
    </script>
</body>
</html>