<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¢ã‚»ãƒƒãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; padding: 20px; margin: 0; }
    h1 { font-size: 1.8em; margin-bottom: 20px; }
    section { margin-top: 30px; padding: 15px; border: 1px solid #333; border-radius: 8px; background: #222; }
    h2 { font-size: 1.3em; margin-top: 0; margin-bottom: 15px; color: #0f0; }
    label { display: block; width: 100%; font-size: 1em; margin-bottom: 5px; color: #bbb; }
    select, input[type="text"], input[type="file"] {
      display: block; width: calc(100% - 12px); /* Paddingè€ƒæ…® */
      font-size: 1em; margin-top: 5px; margin-bottom: 10px;
      padding: 8px 6px; border: 1px solid #444; border-radius: 4px;
      background: #333; color: #fff;
    }
    input[type="file"] { padding: 5px; } /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¯å°‘ã—å°ã•ã‚ã« */
    button {
      background: #007bff; /* é’ç³»ã®ãƒœã‚¿ãƒ³ */
      color: #fff; border: none; padding: 10px 15px; cursor: pointer;
      margin-top: 15px; border-radius: 4px; font-weight: bold;
      transition: background 0.2s ease;
    }
    button:hover { background: #0056b3; }
    button.delete-btn { background: #dc3545; margin-left: 10px; }
    button.delete-btn:hover { background: #c82333; }
    textarea {
      width: calc(100% - 20px); /* Paddingè€ƒæ…® */
      height: 200px; margin-top: 15px;
      background: #000; color: #0f0; font-family: monospace;
      border: 1px solid #444; border-radius: 4px; padding: 10px;
      resize: vertical; /* ãƒªã‚µã‚¤ã‚ºå¯èƒ½ã« */
    }
    .entry {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: 10px; padding: 8px 0; border-bottom: 1px dashed #444;
    }
    .entry:last-child { border-bottom: none; }
    .entry-info { flex: 1; display: flex; align-items: center; }
    .thumb { height: 50px; width: 50px; object-fit: contain; margin-right: 10px; border-radius: 4px; background: #444; }
    .placeholder-thumb { background-color: #666; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #ccc; }
    .input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .input-group input[type="text"] { flex-grow: 1; margin-top: 0; margin-bottom: 0; }
    .input-group button { margin-top: 0; margin-bottom: 0; flex-shrink: 0; }
    .current-value-label {
      font-size: 0.9em;
      color: #aaa;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§© ã‚¢ã‚»ãƒƒãƒˆç®¡ç† v4</h1>
  <button onclick="loadAssetsFromJson()">ğŸ“‚ assets.json èª­è¾¼</button>
  <button onclick="loadScenes()">ğŸ“„ scenes.json ã‹ã‚‰ã‚¿ã‚°æŠ½å‡º</button>

  <section>
    <h2>èƒŒæ™¯ç”»åƒ</h2>
    <div class="input-group">
      <input type="text" id="bg-new-tag" placeholder="æ–°ã—ã„ã‚¿ã‚°åã‚’å…¥åŠ› (ä¾‹: forest_day)" />
      <button onclick="addCustomOption('bg-tag', 'bg-new-tag')">ã‚¿ã‚°è¿½åŠ </button>
    </div>
    <label for="bg-tag">æ—¢å­˜ã®ã‚¿ã‚°ã‚’é¸æŠ / ã¾ãŸã¯æ–°è¦ã‚¿ã‚°åã‚’å…¥åŠ›:</label>
    <select id="bg-tag"></select>
    <input type="file" id="bg-file" accept="image/*" />
    <button onclick="addBackground()">ğŸ–¼ï¸ èƒŒæ™¯ç”»åƒã‚’è¿½åŠ /æ›´æ–°</button>
    <div id="bg-list"></div>
  </section>

  <section>
    <h2>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ</h2>
    <div class="input-group">
      <input type="text" id="char-new-name" placeholder="æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å…¥åŠ› (ä¾‹: hero)" />
      <button onclick="addCustomOption('char-name', 'char-new-name')">åå‰è¿½åŠ </button>
    </div>
    <label for="char-name">æ—¢å­˜ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’é¸æŠ / ã¾ãŸã¯æ–°è¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å…¥åŠ›:</label>
    <select id="char-name"></select>

    <div class="input-group">
      <input type="text" id="char-new-face" placeholder="æ–°ã—ã„è¡¨æƒ…åã‚’å…¥åŠ› (ä¾‹: smile)" />
      <button onclick="addCustomOption('char-face', 'char-new-face')">è¡¨æƒ…è¿½åŠ </button>
    </div>
    <label for="char-face">æ—¢å­˜ã®è¡¨æƒ…ã‚’é¸æŠ / ã¾ãŸã¯æ–°è¦è¡¨æƒ…åã‚’å…¥åŠ›:</label>
    <select id="char-face"></select>

    <input type="file" id="char-file" accept="image/*" />
    <button onclick="addCharacter()">ğŸ‘¤ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’è¿½åŠ /æ›´æ–°</button>
    <div id="char-list"></div>
  </section>

  <section>
    <h2>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒ</h2>
    <div class="input-group">
      <input type="text" id="effect-new-tag" placeholder="æ–°ã—ã„ã‚¿ã‚°åã‚’å…¥åŠ› (ä¾‹: dark_aura)" />
      <button onclick="addCustomOption('effect-tag', 'effect-new-tag')">ã‚¿ã‚°è¿½åŠ </button>
    </div>
    <label for="effect-tag">æ—¢å­˜ã®ã‚¿ã‚°ã‚’é¸æŠ / ã¾ãŸã¯æ–°è¦ã‚¿ã‚°åã‚’å…¥åŠ›:</label>
    <select id="effect-tag"></select>
    <input type="file" id="effect-file" accept="image/*" />
    <button onclick="addEffect()">âœ¨ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒã‚’è¿½åŠ /æ›´æ–°</button>
    <div id="effect-list"></div>
  </section>

  <section>
    <h2>ã‚¢ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
    <button onclick="downloadAssets()">ğŸ’¾ assets.json ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <input type="file" id="assets-file-input" accept=".json" style="display: none;" onchange="handleAssetsUpload(event)" />
    <button onclick="document.getElementById('assets-file-input').click()">â¬†ï¸ assets.json ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    <textarea id="assets-json" readonly></textarea>
  </section>

  <script>
    let assets = { backgrounds: {}, characters: {}, effects: {} };
    // assets.jsonã®ãƒ•ã‚¡ã‚¤ãƒ«å (å­˜åœ¨ã™ã‚‹å ´åˆ)
    const ASSETS_JSON_FILENAME = "assets.json"; 
    const SCENES_JSON_FILENAME = "scenes.json"; // scenes.jsonã®ãƒ•ã‚¡ã‚¤ãƒ«å

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64å½¢å¼ã§èª­ã¿è¾¼ã‚€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
     * @param {File} file - èª­ã¿è¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {Function} cb - èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•° (å¼•æ•°: Base64æ–‡å­—åˆ—)
     */
    function readFileAsBase64(file, cb) {
      if (!file) {
        cb(null); // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯nullã‚’è¿”ã™
        return;
      }
      const reader = new FileReader();
      reader.onload = () => cb(reader.result);
      reader.onerror = () => {
        console.error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", reader.error);
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        cb(null);
      };
      reader.readAsDataURL(file);
    }

    /**
     * scenes.jsonã‚’èª­ã¿è¾¼ã¿ã€å«ã¾ã‚Œã‚‹ã‚¢ã‚»ãƒƒãƒˆã‚¿ã‚°ã‚’æŠ½å‡ºã—ã¦Selectãƒœãƒƒã‚¯ã‚¹ã«åæ˜ ã—ã¾ã™ã€‚
     * microCMSã‹ã‚‰èª­ã¿è¾¼ã‚€ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€APIã‚­ãƒ¼ã¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚
     */
    async function loadScenes() {
      try {
        const res = await fetch(SCENES_JSON_FILENAME);
        if (!res.ok) {
          throw new Error(`scenes.jsonã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${res.statusText}`);
        }
        const data = await res.json();
        const uniq = arr => [...new Set(arr)].filter(x => x && x !== 'ãªã—' && x !== 'ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³'); // ç©ºå€¤ã‚„ç‰¹æ®Šãªã‚¿ã‚°ã‚’é™¤å¤–

        const speakers = uniq(data.map(s => s.speaker));
        const faces = uniq(data.map(s => s.face));
        const backgrounds = uniq(data.map(s => s.background));
        const effects = uniq(data.map(s => s.effect));

        // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿æŒã—ã¤ã¤ã€æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ 
        fillSelect("char-name", speakers, true);
        fillSelect("char-face", faces, true);
        fillSelect("bg-tag", backgrounds, true);
        fillSelect("effect-tag", effects, true);

        alert(`${SCENES_JSON_FILENAME} ã‹ã‚‰ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
      } catch (error) {
        console.error("scenes.json ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        alert(`${SCENES_JSON_FILENAME} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã€å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
      }
    }

    /**
     * Selectãƒœãƒƒã‚¯ã‚¹ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚
     * @param {string} id - Selectãƒœãƒƒã‚¯ã‚¹ã®ID
     * @param {Array<string>} items - è¿½åŠ ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®é…åˆ—
     * @param {boolean} keepExisting - æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿æŒã™ã‚‹ã‹ã©ã†ã‹ (true: ä¿æŒã—è¿½åŠ , false: å…¨ã¦ç½®ãæ›ãˆ)
     */
    function fillSelect(id, items, keepExisting = false) {
      const select = document.getElementById(id);
      const existingValues = keepExisting ? new Set(Array.from(select.options).map(opt => opt.value)) : new Set();

      if (!keepExisting) {
        select.innerHTML = ''; // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã€Œæœªé¸æŠã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- é¸æŠã—ã¦ãã ã•ã„ --";
        select.appendChild(defaultOption);
      }

      items.forEach(item => {
        if (item && !existingValues.has(item)) { // ç©ºã§ãªã„ã€ã‹ã¤æ—¢å­˜ã§ãªã„ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿è¿½åŠ 
          const option = document.createElement("option");
          option.value = item;
          option.textContent = item;
          select.appendChild(option);
          existingValues.add(item); // è¿½åŠ ã—ãŸå€¤ã‚’è¨˜éŒ²
        }
      });
    }

    /**
     * æ–°ã—ã„ã‚¿ã‚°å/ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å/è¡¨æƒ…åã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å–å¾—ã—ã€Selectãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ ã—ã¾ã™ã€‚
     * @param {string} selectId - å¯¾è±¡ã®Selectãƒœãƒƒã‚¯ã‚¹ã®ID
     * @param {string} inputId - ã‚¿ã‚°åã‚’å…¥åŠ›ã™ã‚‹Inputãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ID
     */
    function addCustomOption(selectId, inputId) {
      const input = document.getElementById(inputId);
      const newOptionValue = input.value.trim();
      if (newOptionValue === "") {
        alert("æ–°ã—ã„ã‚¿ã‚°/åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      
      const select = document.getElementById(selectId);
      // æ—¢ã«åŒã˜å€¤ãŒå­˜åœ¨ã—ãªã„ã‹ãƒã‚§ãƒƒã‚¯
      const exists = Array.from(select.options).some(option => option.value === newOptionValue);
      
      if (!exists) {
        const option = document.createElement("option");
        option.value = newOptionValue;
        option.textContent = newOptionValue;
        select.appendChild(option);
        select.value = newOptionValue; // è¿½åŠ å¾Œã€ãã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        input.value = ""; // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      } else {
        alert(`'${newOptionValue}' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚`);
        select.value = newOptionValue; // æ—¢å­˜ã®ã‚‚ã®ã‚’é¸æŠ
      }
    }

    /**
     * èƒŒæ™¯ç”»åƒã‚’è¿½åŠ /æ›´æ–°ã—ã¾ã™ã€‚
     */
    async function addBackground() {
      const tag = document.getElementById("bg-tag").value;
      const file = document.getElementById("bg-file").files[0];

      if (!tag) {
        alert("èƒŒæ™¯ã‚¿ã‚°ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (!file && !assets.backgrounds[tag]) { // æ–°è¦ã‹ã¤ãƒ•ã‚¡ã‚¤ãƒ«ãªã—
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      
      if (file) { // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿Base64ã§èª­ã¿è¾¼ã‚€
        readFileAsBase64(file, data => {
          if (data) {
            assets.backgrounds[tag] = data;
            updateOutput();
            updateList("bg-list", assets.backgrounds, 'backgrounds');
            alert(`èƒŒæ™¯ç”»åƒ '${tag}' ã‚’è¿½åŠ /æ›´æ–°ã—ã¾ã—ãŸã€‚`);
            document.getElementById("bg-file").value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢
          }
        });
      } else { // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãŒã€æ—¢å­˜ã®ã‚¿ã‚°ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆæ›´æ–°ãªã—ï¼‰
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãŸã‚ã€æ—¢å­˜ã®èƒŒæ™¯ç”»åƒã®æ›´æ–°ã¯è¡Œã„ã¾ã›ã‚“ã§ã—ãŸã€‚");
      }
    }

    /**
     * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’è¿½åŠ /æ›´æ–°ã—ã¾ã™ã€‚
     */
    async function addCharacter() {
      const name = document.getElementById("char-name").value;
      const face = document.getElementById("char-face").value;
      const file = document.getElementById("char-file").files[0];

      if (!name || !face) {
        alert("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã¨è¡¨æƒ…ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åãŒã¾ã å­˜åœ¨ã—ãªã„å ´åˆã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
      if (!assets.characters[name]) {
        assets.characters[name] = {};
      }
      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã®ä¸‹ã«è¡¨æƒ…ã®ã‚»ãƒƒãƒˆãŒãªã„å ´åˆã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
      if (!assets.characters[name].normal) { // ä¾‹ã¨ã—ã¦'normal'ã‚»ãƒƒãƒˆã‚’æŒã¤
        assets.characters[name].normal = {};
      }

      if (!file && !assets.characters[name].normal[face]) { // æ–°è¦ã‹ã¤ãƒ•ã‚¡ã‚¤ãƒ«ãªã—
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (file) { // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿Base64ã§èª­ã¿è¾¼ã‚€
        readFileAsBase64(file, data => {
          if (data) {
            assets.characters[name].normal[face] = data;
            updateOutput();
            updateCharList();
            alert(`ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ '${name} (${face})' ã‚’è¿½åŠ /æ›´æ–°ã—ã¾ã—ãŸã€‚`);
            document.getElementById("char-file").value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢
          }
        });
      } else {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãŸã‚ã€æ—¢å­˜ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®æ›´æ–°ã¯è¡Œã„ã¾ã›ã‚“ã§ã—ãŸã€‚");
      }
    }

    /**
     * ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒã‚’è¿½åŠ /æ›´æ–°ã—ã¾ã™ã€‚
     */
    async function addEffect() {
      const tag = document.getElementById("effect-tag").value;
      const file = document.getElementById("effect-file").files[0];

      if (!tag) {
        alert("ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¿ã‚°ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (!file && !assets.effects[tag]) { // æ–°è¦ã‹ã¤ãƒ•ã‚¡ã‚¤ãƒ«ãªã—
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (file) { // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿Base64ã§èª­ã¿è¾¼ã‚€
        readFileAsBase64(file, data => {
          if (data) {
            assets.effects[tag] = data;
            updateOutput();
            updateList("effect-list", assets.effects, 'effects');
            alert(`ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒ '${tag}' ã‚’è¿½åŠ /æ›´æ–°ã—ã¾ã—ãŸã€‚`);
            document.getElementById("effect-file").value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢
          }
        });
      } else {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãŸã‚ã€æ—¢å­˜ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”»åƒã®æ›´æ–°ã¯è¡Œã„ã¾ã›ã‚“ã§ã—ãŸã€‚");
      }
    }
    
    /**
     * ç‰¹å®šã®ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚ï¼ˆèƒŒæ™¯ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ï¼‰
     * @param {string} id - ãƒªã‚¹ãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠID
     * @param {Object} data - è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (ä¾‹: assets.backgrounds)
     * @param {string} assetType - ã‚¢ã‚»ãƒƒãƒˆã®ã‚¿ã‚¤ãƒ— ('backgrounds', 'effects')
     */
    function updateList(id, data, assetType) {
      const container = document.getElementById(id);
      container.innerHTML = "";
      for (const [k, v] of Object.entries(data)) {
        // base64ãƒ‡ãƒ¼ã‚¿ã¯éå¸¸ã«é•·ã„ãŸã‚ã€ä¸€éƒ¨ã ã‘è¡¨ç¤ºã™ã‚‹ã‹ã€ç”»åƒã¨ã—ã¦è¡¨ç¤ºã™ã‚‹
        container.innerHTML += `
          <div class="entry">
            <div class="entry-info">
              <img src="${v}" class="thumb" alt="${k}" title="${k}"/>
              ${k}
            </div>
            <button class="delete-btn" onclick="deleteAsset('${assetType}', '${k}')">å‰Šé™¤</button>
          </div>
        `;
      }
    }

    /**
     * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
     */
    function updateCharList() {
      const container = document.getElementById("char-list");
      container.innerHTML = "";
      for (const [name, set] of Object.entries(assets.characters)) {
        for (const [face, img] of Object.entries(set.normal)) { // 'normal'ã‚»ãƒƒãƒˆã‚’å‰æ
          container.innerHTML += `
            <div class="entry">
              <div class="entry-info">
                <img src="${img}" class="thumb" alt="${name} (${face})" title="${name} (${face})"/>
                ${name}ï¼ˆ${face}ï¼‰
              </div>
              <button class="delete-btn" onclick="deleteAsset('characters', '${name}', '${face}')">å‰Šé™¤</button>
            </div>
          `;
        }
      }
    }

    /**
     * ã‚¢ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§æ•´å½¢ã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã—ã¾ã™ã€‚
     */
    function updateOutput() {
      document.getElementById("assets-json").value = JSON.stringify(assets, null, 2);
    }

    /**
     * ç¾åœ¨ã®ã‚¢ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’assets.jsonã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
     */
    function downloadAssets() {
      const blob = new Blob([JSON.stringify(assets, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = ASSETS_JSON_FILENAME;
      document.body.appendChild(a); // Firefoxå¯¾å¿œ
      a.click();
      document.body.removeChild(a); // Firefoxå¯¾å¿œ
      URL.revokeObjectURL(a.href); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’è§£æ”¾
      alert(`${ASSETS_JSON_FILENAME} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
    }

    /**
     * assets.jsonã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚¢ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
     * @param {Event} event - ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
     */
    function handleAssetsUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const uploadedData = JSON.parse(e.target.result);
          if (uploadedData.backgrounds && uploadedData.characters && uploadedData.effects) {
            assets = uploadedData;
            updateOutput();
            updateAllLists();
            // é¸æŠè‚¢ã‚‚æ›´æ–° (æ—¢å­˜ã‚¢ã‚»ãƒƒãƒˆã®ã‚¿ã‚°ãŒé¸æŠè‚¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«)
            populateInitialSelectsFromAssets();
            alert(`${ASSETS_JSON_FILENAME} ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
          } else {
            throw new Error("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
          }
        } catch (error) {
          console.error("assets.jsonã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
          alert(`assets.jsonã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
      };
      reader.onerror = () => {
        console.error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", reader.error);
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      };
      reader.readAsText(file);
    }

    /**
     * ã‚¢ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚
     * @param {string} type - ã‚¢ã‚»ãƒƒãƒˆã®ã‚¿ã‚¤ãƒ— ('backgrounds', 'characters', 'effects')
     * @param {string} key - ã‚¢ã‚»ãƒƒãƒˆã®ã‚­ãƒ¼ (èƒŒæ™¯/ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã‚¿ã‚°ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å)
     * @param {string} [subKey] - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å ´åˆã®ã‚µãƒ–ã‚­ãƒ¼ (è¡¨æƒ…å)
     */
    function deleteAsset(type, key, subKey = null) {
      if (!confirm(`æœ¬å½“ã«'${key}${subKey ? ' (' + subKey + ')' : ''}'ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      if (type === 'backgrounds') {
        delete assets.backgrounds[key];
        updateList("bg-list", assets.backgrounds, 'backgrounds');
        fillSelect('bg-tag', Object.keys(assets.backgrounds), false); // Selectãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
      } else if (type === 'effects') {
        delete assets.effects[key];
        updateList("effect-list", assets.effects, 'effects');
        fillSelect('effect-tag', Object.keys(assets.effects), false); // Selectãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
      } else if (type === 'characters' && subKey) {
        if (assets.characters[key] && assets.characters[key].normal) {
          delete assets.characters[key].normal[subKey];
          // ã‚‚ã—ãã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«è¡¨æƒ…ãŒãªããªã£ãŸã‚‰ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‡ªä½“ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã‚‚æ¤œè¨
          if (Object.keys(assets.characters[key].normal).length === 0) {
            delete assets.characters[key];
          }
        }
        updateCharList();
        fillSelect('char-name', Object.keys(assets.characters), false); // Selectãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
        fillSelect('char-face', getUniqueFaces(), false); // è¡¨æƒ…ã®é¸æŠè‚¢ã‚‚æ›´æ–°
      }
      updateOutput();
      alert("ã‚¢ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    /**
     * å…¨ã¦ã®ã‚¢ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
     */
    function updateAllLists() {
      updateList("bg-list", assets.backgrounds, 'backgrounds');
      updateCharList();
      updateList("effect-list", assets.effects, 'effects');
    }

    /**
     * ã‚¢ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸã®é¸æŠè‚¢ã‚’populateã—ã¾ã™ã€‚
     * assets.jsonãƒ­ãƒ¼ãƒ‰å¾Œã‚„ã€assetsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°å¾Œã«å‘¼ã³å‡ºã—ã¾ã™ã€‚
     */
    function populateInitialSelectsFromAssets() {
      fillSelect('bg-tag', Object.keys(assets.backgrounds), false);
      fillSelect('char-name', Object.keys(assets.characters), false);
      fillSelect('char-face', getUniqueFaces(), false);
      fillSelect('effect-tag', Object.keys(assets.effects), false);
    }

    /**
     * ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¡¨æƒ…ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚
     */
    function getUniqueFaces() {
        const uniqueFaces = new Set();
        for (const name in assets.characters) {
            if (assets.characters[name].normal) {
                for (const face in assets.characters[name].normal) {
                    uniqueFaces.add(face);
                }
            }
        }
        return Array.from(uniqueFaces);
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
    document.addEventListener('DOMContentLoaded', () => {
        // assets.json ãŒå­˜åœ¨ã™ã‚Œã°è‡ªå‹•ã§èª­ã¿è¾¼ã‚€
        loadAssetsFromJson();
    });

    /**
     * assets.json ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚
     */
    async function loadAssetsFromJson() {
        try {
            const res = await fetch(ASSETS_JSON_FILENAME);
            if (!res.ok) {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã¨ã¯ã—ãªã„
                // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ãªã©ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆãŒã‚ã‚‹ãŸã‚
                console.warn(`${ASSETS_JSON_FILENAME} ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–°è¦ä½œæˆã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
                updateOutput(); // ç©ºã®assetsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§JSONã‚’åˆæœŸåŒ–
                return;
            }
            const data = await res.json();
            if (data.backgrounds && data.characters && data.effects) {
                assets = data;
                updateOutput();
                updateAllLists();
                populateInitialSelectsFromAssets();
                alert(`${ASSETS_JSON_FILENAME} ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
            } else {
                console.warn(`${ASSETS_JSON_FILENAME} ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚æ–°è¦ä½œæˆã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
                updateOutput();
            }
        } catch (error) {
            console.error(`${ASSETS_JSON_FILENAME} ã®è‡ªå‹•èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
            alert(`è‡ªå‹•èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ ${ASSETS_JSON_FILENAME} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚`);
            updateOutput();
        }
    }
  </script>
</body>
</html>
